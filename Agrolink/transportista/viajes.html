<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Viajes | AgroLink</title>

  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="../img/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .tab {
      background: #f3f3f3;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #333;
      transition: 0.2s;
    }

    .tab.active {
      background: #2b7a0b;
      color: #fff;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      background: #f9fff9;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .stat {
      flex: 1;
      text-align: center;
    }

    .stat h3 {
      color: #2b7a0b;
      margin-bottom: 0.3rem;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      transition: transform .2s;
    }

    .card:hover {
      transform: scale(1.02);
    }

    .viaje-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .estado {
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: bold;
      color: #fff;
    }

    .estado.en-curso { background: #2b7a0b; }
    .estado.completado { background: #0077cc; }
    .estado.cancelado { background: #555; }

    .progress-bar {
      background: #eee;
      height: 8px;
      border-radius: 5px;
      margin: 8px 0 10px 0;
    }

    .progress {
      height: 8px;
      background: #2b7a0b;
      border-radius: 5px;
      transition: width .5s;
    }

    .btns {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color .2s ease;
    }

    .btn-mapa { background: #2b7a0b; color: #fff; }
    .btn-info { background: #0077cc; color: #fff; }
    .btn-completado { background: #27ae60; color: #fff; }
    .btn-mapa:hover { background: #256707; }
    .btn-info:hover { background: #005fa3; }
    .btn-completado:hover { background: #1e874b; }

    #map {
      height: 400px;
      border-radius: 12px;
      margin-top: 1rem;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      position: relative;
    }

    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo-section custom-logo">
        <i class="fa-solid fa-tractor"></i>
        <div class="logo-text">
          <span class="brand">AgroLink</span>
          <span class="role">Transportista</span>
        </div>
      </div>

      <nav class="nav-links">
        <a href="dashboard.html"><i class="fa-solid fa-home"></i> Panel de control</a>
        <a href="solicitudes.html"><i class="fa-solid fa-list"></i> Solicitudes disponibles</a>
        <a href="viajes.html" class="active"><i class="fa-solid fa-truck"></i> Mis viajes</a>
        <a href="perfil.html"><i class="fa-solid fa-user"></i> Perfil</a>
      </nav>

      <div class="help-section">
        <a href="#"><i class="fa-regular fa-circle-question"></i> Ayuda</a>
        <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesi√≥n</a>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h1>Historial de Viajes</h1>
        <p>Consulta tus viajes completados, en curso y cancelados.</p>
      </header>

      <section class="stats">
        <div class="stat"><h3>üöõ En curso</h3><p id="statEnCurso">0</p></div>
        <div class="stat"><h3>‚úÖ Completados</h3><p id="statCompletados">0</p></div>
        <div class="stat"><h3>üí∞ Ingresos Totales</h3><p>S/ <span id="statGanancias">0</span></p></div>
        <div class="stat"><h3>‚≠ê Promedio</h3><p id="statCalificacion">4.8</p></div>
      </section>

      <div class="tabs">
        <button class="tab active" data-tab="enCurso">En curso</button>
        <button class="tab" data-tab="completado">Completados</button>
        <button class="tab" data-tab="cancelado">Cancelados</button>
      </div>

      <section id="listaViajes"></section>
      <div id="map"></div>
    </main>
  </div>

  <div class="modal" id="modalDetalles">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Detalles del viaje</h2>
      <div id="detalleContenido"></div>
    </div>
  </div>

  <footer class="footer">
    <p>¬© 2025 AgroLink. Todos los derechos reservados.</p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="../js/toast.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const usuario = JSON.parse(localStorage.getItem("agrolinkUsuario")) || {};
      const db = JSON.parse(localStorage.getItem("solicitudesAgroLink")) || [];
      const lista = document.getElementById("listaViajes");
      const map = L.map('map').setView([-9.189967, -75.015152], 6);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

      const coords = {
        Lima: [-12.0464, -77.0428],
        Trujillo: [-8.1117, -79.0288],
        Arequipa: [-16.409, -71.5375],
        Piura: [-5.1945, -80.6328],
        Chiclayo: [-6.7714, -79.8409],
        Cusco: [-13.5319, -71.9675],
      };

      const viajes = db.filter(s => s.transportista === usuario.nombre && s.estado !== "Pendiente");

      const enCurso = viajes.filter(v => v.estado === "En curso").length;
      const completados = viajes.filter(v => v.estado === "Completado ‚úÖ").length;
      const totalGanado = viajes.reduce((acc, v) => acc + (parseFloat(v.pago) || 0), 0);

      document.getElementById("statEnCurso").textContent = enCurso;
      document.getElementById("statCompletados").textContent = completados;
      document.getElementById("statGanancias").textContent = totalGanado.toFixed(2);

      function render(tab = "enCurso") {
        lista.innerHTML = "";

        const filtrados = viajes.filter(v =>
          tab === "enCurso" ? v.estado === "En curso" :
          tab === "completado" ? v.estado === "Completado ‚úÖ" :
          v.estado === "Cancelado ‚ùå"
        );

        if (filtrados.length === 0) {
          lista.innerHTML = "<p>No hay viajes en esta categor√≠a.</p>";
          return;
        }

        filtrados.forEach(v => {
          const origen = coords[v.origen] || [-9, -75];
          const destino = coords[v.destino] || [-9.1, -75.1];
          const distancia = (map.distance(origen, destino) / 1000).toFixed(1);
          const duracion = (distancia / 70).toFixed(1);
          const estadoClass = v.estado.includes("Completado") ? "completado" :
                              v.estado.includes("Cancelado") ? "cancelado" : "en-curso";
          const progress = v.estado.includes("Completado") ? 100 :
                           v.estado.includes("En curso") ? 60 : 0;

          const card = document.createElement("div");
          card.classList.add("card");
          card.innerHTML = `
            <div class="viaje-header">
              <h3>üöõ ${v.origen} ‚Üí ${v.destino}</h3>
              <span class="estado ${estadoClass}">${v.estado}</span>
            </div>
            <p><strong>Producto:</strong> ${v.tipo}</p>
            <p><strong>Productor:</strong> ${v.productor || "Desconocido"}</p>
            <p><strong>Distancia:</strong> ${distancia} km | <strong>Duraci√≥n:</strong> ${duracion} h</p>
            <div class="progress-bar"><div class="progress" style="width:${progress}%;"></div></div>
            <div class="btns">
              <button class="btn btn-mapa" data-origen="${v.origen}" data-destino="${v.destino}">Ver ruta</button>
              <button class="btn btn-info" data-detalles='${JSON.stringify(v)}'>Detalles</button>
              ${v.estado === "En curso" ? `<button class="btn btn-completado" data-id="${v.origen}-${v.destino}">Viaje completado ‚úÖ</button>` : ""}
            </div>
          `;
          lista.appendChild(card);
        });
      }

      render();

      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          render(tab.dataset.tab);
        });
      });

      lista.addEventListener("click", e => {
        if (e.target.classList.contains("btn-completado")) {
          const id = e.target.dataset.id.split("-");
          const origen = id[0], destino = id[1];
          const index = db.findIndex(s => s.origen === origen && s.destino === destino && s.estado === "En curso");
          if (index !== -1) {
            db[index].estado = "Completado ‚úÖ";
            localStorage.setItem("solicitudesAgroLink", JSON.stringify(db));
            showToast("‚úÖ Viaje marcado como completado.", "success");
            setTimeout(() => location.reload(), 800);
          }
        }
      });

      // Ver ruta
      lista.addEventListener("click", e => {
        if (!e.target.classList.contains("btn-mapa")) return;
        const origen = coords[e.target.dataset.origen];
        const destino = coords[e.target.dataset.destino];
        if (!origen || !destino) return;
        map.eachLayer(l => { if (l instanceof L.Polyline || l instanceof L.Marker) map.removeLayer(l); });
        L.marker(origen).addTo(map).bindPopup("Origen: " + e.target.dataset.origen);
        L.marker(destino).addTo(map).bindPopup("Destino: " + e.target.dataset.destino);
        L.polyline([origen, destino], { color: "#2b7a0b", weight: 4 }).addTo(map);
        map.fitBounds([origen, destino]);
      });

      // Modal detalles
      const modal = document.getElementById("modalDetalles");
      const detalleContenido = document.getElementById("detalleContenido");
      document.querySelector(".close").addEventListener("click", () => modal.style.display = "none");
      modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

      lista.addEventListener("click", e => {
        if (!e.target.classList.contains("btn-info")) return;
        const data = JSON.parse(e.target.dataset.detalles);
        detalleContenido.innerHTML = `
          <p><strong>Productor:</strong> ${data.productor}</p>
          <p><strong>Producto:</strong> ${data.tipo}</p>
          <p><strong>Origen:</strong> ${data.origen}</p>
          <p><strong>Destino:</strong> ${data.destino}</p>
          <p><strong>Fecha:</strong> ${data.fecha}</p>
          <p><strong>Peso:</strong> ${data.peso} kg</p>
          <p><strong>Pago:</strong> S/ ${data.pago}</p>
        `;
        modal.style.display = "flex";
      });

      document.getElementById("logout").addEventListener("click", e => {
        e.preventDefault();
        showToast("üëã Sesi√≥n cerrada correctamente", "info");
        localStorage.removeItem("agrolinkRol");
        localStorage.removeItem("agrolinkUsuario");
        setTimeout(() => (window.location.href = "../index.html"), 1000);
      });
    });
  </script>
</body>
</html>
