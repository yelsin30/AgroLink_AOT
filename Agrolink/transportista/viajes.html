<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historial de Viajes | AgroLink</title>

  <!-- Ãconos y mapa -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <!-- Estilo principal AgroLink -->
  <link rel="stylesheet" href="../css/Transporte/EstiloT.css" />

  <style>
    /* Ajustes extra para esta pÃ¡gina */
    #map {
      height: 420px;
      width: 100%;
      border-radius: 14px;
      margin-top: 1.2rem;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
    }

    .card-viaje {
      background: #fff;
      border-radius: 14px;
      padding: 1rem 1.3rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 1rem;
      border-left: 5px solid #00b074;
      transition: transform .2s ease, box-shadow .2s ease;
      cursor: pointer;
    }
    .card-viaje:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 176, 116, 0.2);
    }

    .viaje-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }
    .viaje-header h6 {
      margin: 0;
      font-size: 1rem;
      color: #16291b;
      font-weight: 700;
    }
    .viaje-header .estado {
      font-size: 0.85rem;
      padding: .3rem .6rem;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      text-transform: capitalize;
    }
    .estado.en\ curso { background-color: #00b074; }
    .estado.completado { background-color: #16291b; }
    .estado.cancelado,
    .estado.rechazada { background-color: #d13c3c; }

    .tab-btn {
      border: 1px solid #00b074;
      background: #fff;
      color: #16291b;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 600;
    }
    .tab-btn.active {
      background: #00b074;
      color: #fff;
    }

    .route-info {
      margin-top: 0.8rem;
      padding: 0.8rem 1rem;
      border-radius: 12px;
      background: #f1f8f1;
      border: 1px solid #cde3cd;
      font-size: 0.95rem;
      color: #16291b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .route-info i {
      color: #00b074;
      font-size: 1.1rem;
    }
    .route-info strong {
      color: #00b074;
    }
  </style>
</head>

<body>
  <!-- === SIDEBAR === -->
  <aside class="sidebar">
    <i class="fa-solid fa-tractor logo"></i>
    <div class="nav-icons">
      <button onclick="location.href='dashboard.html'"><i class="fa-solid fa-home"></i></button>
      <button onclick="location.href='solicitudes.html'"><i class="fa-solid fa-list"></i></button>
      <button class="active" onclick="location.href='viajes.html'"><i class="fa-solid fa-truck"></i></button>
      <button onclick="location.href='perfil.html'"><i class="fa-solid fa-user"></i></button>
    </div>
    <button class="logout-btn" id="logout">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Salir</span>
    </button>
  </aside>

  <!-- === CONTENIDO PRINCIPAL === -->
  <main>
    <div class="content-container">
      <header>
        <h1><i class="fa-solid fa-road"></i> Historial de Viajes</h1>
        <p>Consulta tus viajes completados, en curso y cancelados, con detalles de ruta, distancia y tiempo.</p>
      </header>

      <!-- === TARJETAS KPI === -->
      <div class="stats-row" id="stats">
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-truck"></i></div>
          <div class="stat-text">
            <h4 id="enCurso">0</h4>
            <span>En curso</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-check"></i></div>
          <div class="stat-text">
            <h4 id="completados">0</h4>
            <span>Completados</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-sack-dollar"></i></div>
          <div class="stat-text">
            <h4 id="totalGanado">S/ 0.00</h4>
            <span>Ingresos Totales</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-star"></i></div>
          <div class="stat-text">
            <h4>4.8</h4>
            <span>Promedio</span>
          </div>
        </div>
      </div>

      <!-- === PANEL PRINCIPAL === -->
      <div class="panel">
        <h5><i class="fa-solid fa-map-location-dot"></i> Rutas y Viajes</h5>

        <div class="tabs d-flex gap-2 mb-3">
          <button class="tab-btn active" data-tab="curso">En curso</button>
          <button class="tab-btn" data-tab="completados">Completados</button>
          <button class="tab-btn" data-tab="cancelados">Cancelados</button>
        </div>

        <div id="viajesContainer" class="viajes-list">
          <p class="text-muted">No hay viajes en esta categorÃ­a.</p>
        </div>

        <div id="map"></div>
        <div id="routeInfo" class="route-info">
          <i class="fa-solid fa-route"></i>
          <span>Selecciona un viaje de la lista para ver la ruta detallada.</span>
        </div>
      </div>

      <footer>Â© 2025 AgroLink. Todos los derechos reservados.</footer>
    </div>
  </main>

  <!-- === SCRIPTS === -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // === MAPA BASE ===
      const map = L.map("map").setView([-9.19, -75.015], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const routeInfo = document.getElementById("routeInfo");
      let routingControl = null;

      // === DATOS DESDE LOCALSTORAGE ===
      const solicitudes = JSON.parse(localStorage.getItem("solicitudesAgroLink")) || [];

      const viajesEnCurso = solicitudes.filter(v => /curso/i.test(v.estado));
      const viajesCompletados = solicitudes.filter(v => /completad/i.test(v.estado));
      const viajesCancelados = solicitudes.filter(v => /cancelad|rechazad/i.test(v.estado));

      // === KPI ===
      document.getElementById("enCurso").textContent = viajesEnCurso.length;
      document.getElementById("completados").textContent = viajesCompletados.length;
      const totalGanado = viajesCompletados.reduce(
        (acc, v) => acc + (parseFloat(v.pagoFinal || v.pago) || 0),
        0
      );
      document.getElementById("totalGanado").textContent = `S/ ${totalGanado.toFixed(2)}`;

      const container = document.getElementById("viajesContainer");

      // Obtener coords desde Nominatim
      async function obtenerCoords(ciudad) {
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              ciudad + ", PerÃº"
            )}`
          );
          const data = await res.json();
          return data[0] ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        } catch (err) {
          console.error("Error obteniendo coordenadas:", err);
          return null;
        }
      }

      // Renderizar lista y conectar con mapa
      async function renderViajes(lista) {
        container.innerHTML = "";
        if (lista.length === 0) {
          container.innerHTML = "<p class='text-muted'>No hay viajes en esta categorÃ­a.</p>";
          routeInfo.innerHTML = `
            <i class="fa-solid fa-route"></i>
            <span>Selecciona un viaje de la lista para ver la ruta detallada.</span>
          `;
          return;
        }

        for (const v of lista) {
          const card = document.createElement("div");
          card.classList.add("card-viaje");
          card.innerHTML = `
            <div class="viaje-header">
              <h6><i class="fa-solid fa-truck"></i> ${v.origen} â†’ ${v.destino}</h6>
              <span class="estado ${v.estado.toLowerCase()}">${v.estado}</span>
            </div>
            <p><strong>Fecha:</strong> ${v.fecha || "No especificada"}</p>
            <p><strong>Pago:</strong> S/ ${(v.pagoFinal || v.pago || 0)}</p>
          `;

          card.addEventListener("click", async () => {
            const origen = await obtenerCoords(v.origen);
            const destino = await obtenerCoords(v.destino);

            if (!origen || !destino) {
              routeInfo.innerHTML = `
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span>No se pudo calcular la ruta para este viaje.</span>
              `;
              return;
            }

            // Limpiar ruta anterior
            if (routingControl) {
              map.removeControl(routingControl);
              routingControl = null;
            }

            routingControl = L.Routing.control({
              waypoints: [L.latLng(origen), L.latLng(destino)],
              lineOptions: { styles: [{ color: "#00b074", weight: 5 }] },
              showAlternatives: false,
              addWaypoints: false,
              draggableWaypoints: false,
              fitSelectedRoutes: true,
              createMarker: (i, wp) => {
                return L.marker(wp.latLng, {
                  icon: L.icon({
                    iconUrl:
                      i === 0
                        ? "https://cdn-icons-png.flaticon.com/512/809/809957.png"
                        : "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                    iconSize: [32, 32]
                  })
                }).bindPopup(
                  i === 0
                    ? `ðŸšš <b>Origen:</b> ${v.origen}`
                    : `<b>Destino:</b> ${v.destino}`
                );
              }
            })
              .on("routesfound", e => {
                const route = e.routes[0];
                const distKm = route.summary.totalDistance / 1000;
                const tiempoSeg = route.summary.totalTime;
                const horas = Math.floor(tiempoSeg / 3600);
                const minutos = Math.round((tiempoSeg % 3600) / 60);

                routeInfo.innerHTML = `
                  <i class="fa-solid fa-route"></i>
                  <span>
                    <strong>Ruta seleccionada:</strong> ${v.origen} â†’ ${v.destino}<br>
                    <strong>Distancia:</strong> ${distKm.toFixed(1)} km &nbsp; | &nbsp;
                    <strong>DuraciÃ³n estimada:</strong> ${horas} h ${minutos} min
                  </span>
                `;
              })
              .addTo(map);
          });

          container.appendChild(card);
        }
      }

      // Render inicial: viajes en curso
      renderViajes(viajesEnCurso);

      // Tabs
      const tabBtns = document.querySelectorAll(".tab-btn");
      tabBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          tabBtns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          const tab = btn.dataset.tab;
          if (tab === "curso") renderViajes(viajesEnCurso);
          else if (tab === "completados") renderViajes(viajesCompletados);
          else renderViajes(viajesCancelados);
        });
      });

      // Logout
      document.getElementById("logout").addEventListener("click", () => {
        localStorage.clear();
        alert("ðŸ‘‹ SesiÃ³n cerrada correctamente");
        window.location.href = "../index.html";
      });
    });
  </script>
</body>
</html>
