<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historial de Viajes | AgroLink</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="../css/Transporte/EstiloViajes.css" />
</head>

<body>
  <aside class="sidebar">
    <i class="fa-solid fa-tractor logo"></i>
    <div class="nav-icons">
      <button onclick="location.href='dashboard.html'"><i class="fa-solid fa-house"></i></button>
      <button onclick="location.href='solicitudes.html'"><i class="fa-solid fa-list"></i></button>
      <button class="active"><i class="fa-solid fa-truck"></i></button>
      <button onclick="location.href='perfil.html'"><i class="fa-solid fa-user"></i></button>
    </div>
    <button class="logout-btn" id="logout">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Salir</span>
    </button>
  </aside>

  <main>
    <div class="content-container">
      <header>
        <h1><i class="fa-solid fa-road"></i> Historial de Viajes</h1>
        <p>Consulta tus viajes completados, en curso y cancelados, con detalles de ruta, distancia y tiempo.</p>
      </header>

      <div class="stats-row" id="stats">
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-truck"></i></div>
          <div class="stat-text">
            <h4 id="enCurso">0</h4><span>En curso</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-check"></i></div>
          <div class="stat-text">
            <h4 id="completados">0</h4><span>Completados</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-sack-dollar"></i></div>
          <div class="stat-text">
            <h4 id="totalGanado">S/ 0.00</h4><span>Ingresos Totales</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-star"></i></div>
          <div class="stat-text">
            <h4>4.8</h4><span>Promedio</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <h5><i class="fa-solid fa-map-location-dot"></i> Rutas y Viajes</h5>
        <div class="tabs">
          <button class="tab-btn active" data-tab="curso">En curso</button>
          <button class="tab-btn" data-tab="completados">Completados</button>
          <button class="tab-btn" data-tab="cancelados">Cancelados</button>
        </div>

        <div id="viajesContainer" class="viajes-list">
          <p class="text-muted">No hay viajes en esta categorÃ­a.</p>
        </div>

        <div id="map"></div>
        <div id="routeInfo" class="route-info">
          <i class="fa-solid fa-route"></i>
          <span>Selecciona un viaje de la lista para ver la ruta detallada.</span>
        </div>
      </div>

      <div class="detalle-overlay" id="detalleOverlay">
        <div class="detalle-panel">
          <div class="detalle-header">
            <h2><i class="fa-solid fa-box"></i> Detalles del Pedido</h2>
            <button class="detalle-cerrar" id="cerrarDetalle"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="detalle-content" id="detalleContenido"></div>
          <button id="btnRuta"><i class="fa-solid fa-route"></i> Ver ruta en el mapa</button>
        </div>
      </div>

      <footer>Â© 2025 AgroLink. Todos los derechos reservados.</footer>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {

      // === ðŸ” VerificaciÃ³n y sincronizaciÃ³n de sesiÃ³n ===
      const sesionGuardada = localStorage.getItem("agrolinkUsuario");
      if (!sesionGuardada) {
        window.location.href = "../login.html";
        return;
      }

      let usuario = JSON.parse(sesionGuardada);
      let usuariosLista = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
      const idx = usuariosLista.findIndex(u => (u.email || u.correo) === (usuario.email || usuario.correo));
      if (idx !== -1) {
        usuario = usuariosLista[idx];
        localStorage.setItem("agrolinkUsuario", JSON.stringify(usuario));
      }

      // === MAPA ===
      const map = L.map("map").setView([-9.19, -75.015], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap contributors" }).addTo(map);
      let routingControl = null;
      const routeInfo = document.getElementById("routeInfo");
      let solicitudes = JSON.parse(localStorage.getItem("solicitudesAgroLink")) || [];

      const panel = document.getElementById("detalleOverlay");
      const btnCerrar = document.getElementById("cerrarDetalle");
      const btnRuta = document.getElementById("btnRuta");

      async function obtenerCoords(ciudad) {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ciudad + ", PerÃº")}`);
          const data = await res.json();
          return data[0] ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        } catch { return null; }
      }

      async function mostrarRuta(viaje) {
        const origen = await obtenerCoords(viaje.origen);
        const destino = await obtenerCoords(viaje.destino);
        if (!origen || !destino) {
          routeInfo.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i><span>No se pudo calcular la ruta.</span>`;
          return;
        }
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
          waypoints: [L.latLng(origen), L.latLng(destino)],
          lineOptions: { styles: [{ color: "#00b074", weight: 5 }] },
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: true
        }).on("routesfound", e => {
          const r = e.routes[0], d = r.summary.totalDistance / 1000, t = r.summary.totalTime;

          // âœ… Mostrar la ruta con datos reales
          routeInfo.innerHTML = `<i class="fa-solid fa-route"></i>
    <span><strong>Ruta:</strong> ${viaje.origen} â†’ ${viaje.destino}<br>
    <strong>Distancia:</strong> ${d.toFixed(1)} km | <strong>DuraciÃ³n:</strong> ${Math.floor(t / 3600)}h ${Math.round((t % 3600) / 60)}min</span>`;

          // âœ… Guardar la distancia real en el viaje dentro de solicitudesAgroLink
          viaje.distancia = d.toFixed(1);
          localStorage.setItem("solicitudesAgroLink", JSON.stringify(solicitudes));
        }).addTo(map);

      }

      function actualizarKPIs() {
        const enCurso = solicitudes.filter(v => /curso/i.test(v.estado));
        const completados = solicitudes.filter(v => /completad/i.test(v.estado));
        const total = completados.reduce((a, v) => a + (parseFloat(v.pagoFinal || v.pago) || 0), 0);
        document.getElementById("enCurso").textContent = enCurso.length;
        document.getElementById("completados").textContent = completados.length;
        document.getElementById("totalGanado").textContent = `S/ ${total.toFixed(2)}`;
      }

      async function renderViajes(lista) {
        const container = document.getElementById("viajesContainer");
        container.innerHTML = lista.length ? "" : "<p class='text-muted'>No hay viajes en esta categorÃ­a.</p>";
        lista.forEach(v => {
          const card = document.createElement("div");
          card.classList.add("card-viaje");
          card.innerHTML = `
            <div class="viaje-header">
              <h6><i class="fa-solid fa-truck"></i> ${v.origen} â†’ ${v.destino}</h6>
              <span class="estado ${v.estado.toLowerCase()}">${v.estado}</span>
            </div>
            <p><strong>Fecha:</strong> ${v.fecha || "No especificada"}</p>
            <p><strong>Pago:</strong> S/ ${(v.pagoFinal || v.pago || 0).toFixed(2)}</p>
            <div class="botones-viaje">
              <button class="btn-ver" onclick="verDetalles('${v.id}')">Ver Detalles</button>
              ${/curso/i.test(v.estado) ? `<button class="btn-completar" onclick="marcarCompletado('${v.id}')">Marcar como Completado</button>` : ""}
            </div>`;
          card.addEventListener("click", e => { if (!e.target.closest(".botones-viaje")) mostrarRuta(v); });
          container.appendChild(card);
        });
      }

      window.verDetalles = id => {
        const s = solicitudes.find(x => x.id === id);
        if (!s) return;
        document.getElementById("detalleContenido").innerHTML = `
          <p><strong>ID:</strong> ${s.id}</p>
          <p><strong>Productor:</strong> ${s.productor}</p>
          <p><strong>Origen:</strong> ${s.origen}</p>
          <p><strong>Destino:</strong> ${s.destino}</p>
          <p><strong>Peso:</strong> ${s.peso} kg</p>
          <p><strong>Pago:</strong> S/ ${s.pago}</p>
          <p><strong>Fecha:</strong> ${s.fecha}</p>
          <p><strong>TelÃ©fono:</strong> ${s.telefono || "No registrado"}</p>
          ${s.fechaCompletado ? `<p><strong>Completado el:</strong> ${s.fechaCompletado}</p>` : ""}`;
        panel.classList.add("show");
        btnRuta.onclick = () => { mostrarRuta(s); panel.classList.remove("show"); };
      };

      btnCerrar.onclick = () => panel.classList.remove("show");
      panel.addEventListener("click", e => { if (e.target === panel) panel.classList.remove("show"); });

      window.marcarCompletado = id => {
        const s = solicitudes.find(x => x.id === id);
        if (!s) return;
        s.estado = "Completado";
        s.fechaCompletado = new Date().toLocaleString("es-PE");
        localStorage.setItem("solicitudesAgroLink", JSON.stringify(solicitudes));
        actualizarKPIs();
        renderViajes(solicitudes.filter(v => /curso/i.test(v.estado)));
        alert(`âœ… El viaje ${s.origen} â†’ ${s.destino} fue completado.`);
      };

      const tabs = document.querySelectorAll(".tab-btn");
      tabs.forEach(tab => {
        tab.addEventListener("click", e => {
          tabs.forEach(t => t.classList.remove("active"));
          e.target.classList.add("active");
          const tipo = e.target.dataset.tab;
          let lista = [];
          if (tipo === "curso") lista = solicitudes.filter(v => /curso/i.test(v.estado));
          if (tipo === "completados") lista = solicitudes.filter(v => /completad/i.test(v.estado));
          if (tipo === "cancelados") lista = solicitudes.filter(v => /cancelad/i.test(v.estado));
          renderViajes(lista);
        });
      });

      // === Logout persistente ===
      document.getElementById("logout").onclick = () => {
        const usuarios = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];
        const idx = usuarios.findIndex(u => (u.email || u.correo) === (usuario.email || usuario.correo));
        if (idx !== -1) {
          usuarios[idx].sesionActiva = false;
          localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuarios));
        }
        localStorage.removeItem("agrolinkUsuario");
        localStorage.removeItem("agrolinkRol");
        alert("ðŸ‘‹ SesiÃ³n cerrada correctamente");
        location.href = "../index.html";
      };

      actualizarKPIs();
      renderViajes(solicitudes.filter(v => /curso/i.test(v.estado)));
    });
  </script>
</body>

</html>