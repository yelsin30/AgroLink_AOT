<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Transportista | AgroLink</title>

  <link rel="icon" href="../../img/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/Transporte/chatT.css" />
</head>

<body>
  <div class="chat-page">
    <header class="chat-header">
      <button class="btn-volver" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Volver</button>
      <div class="chat-info">
        <i class="fa-solid fa-seedling"></i>
        <div>
          <h5 id="nombreProductor">Productor</h5>
          <small>Conectado...</small>
        </div>
      </div>
    </header>

    <main class="chat-body" id="chatBody"></main>

    <footer class="chat-footer">
      <div class="input-wrap">
        <button class="icon-btn"><i class="fa-solid fa-paperclip"></i></button>
        <input id="mensajeInput" type="text" placeholder="Escribe un mensaje..." />
        <button id="enviarBtn" class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const envioID = params.get("id");
      const productor = params.get("productor") || "Productor";
      const chatKey = `chat_${envioID}`;
      const chatBody = document.getElementById("chatBody");

      const usuario = JSON.parse(localStorage.getItem("agrolinkUsuario") || "{}");
      const nombreTransportista = usuario.nombre || "Transportista";
      const fotoTransportista = usuario.foto || null;

      document.getElementById("nombreProductor").textContent = productor;

      let mensajes = JSON.parse(localStorage.getItem(chatKey)) || [];

      // Mensaje automÃ¡tico del bot (solo una vez)
      if (!mensajes.some(m => m.tipo === "bot")) {
        const botMsg = {
          remitente: "AgroLink BOT",
          rol: "bot",
          texto: "ðŸšš Â¡Hola! Soy el productor, gracias por aceptar el envÃ­o. Puedes comunicarte conmigo por aquÃ­.",
          fecha: new Date().toISOString(),
          tipo: "bot"
        };
        mensajes.push(botMsg);
        localStorage.setItem(chatKey, JSON.stringify(mensajes));
      }

      function renderMensajes() {
        chatBody.innerHTML = "";
        mensajes.forEach(msg => {
          const isMine = msg.rol === "transportista";
          const isBot = msg.rol === "bot";

          const contenedor = document.createElement("div");
          contenedor.classList.add("mensaje-contenedor", isMine ? "enviado" : "recibido");

          const avatar = document.createElement("div");
          avatar.classList.add("avatar");
          avatar.textContent = isBot ? "ðŸ¤–" : msg.remitente.charAt(0).toUpperCase();

          const burbuja = document.createElement("div");
          burbuja.classList.add("mensaje", isMine ? "msg-enviado" : "msg-recibido");
          if (isBot) burbuja.style.background = "#bde2c4";

          const hora = new Date(msg.fecha).toLocaleTimeString("es-PE", { hour: "2-digit", minute: "2-digit" });
          burbuja.innerHTML = `<p>${msg.texto}</p><small>${hora}</small>`;

          if (isMine) { contenedor.appendChild(burbuja); contenedor.appendChild(avatar); }
          else { contenedor.appendChild(avatar); contenedor.appendChild(burbuja); }

          chatBody.appendChild(contenedor);
        });
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function enviarMensaje() {
        const input = document.getElementById("mensajeInput");
        const texto = input.value.trim();
        if (!texto) return;
        const nuevoMsg = {
          remitente: nombreTransportista,
          rol: "transportista",
          texto,
          fecha: new Date().toISOString(),
          foto: fotoTransportista
        };
        mensajes.push(nuevoMsg);
        localStorage.setItem(chatKey, JSON.stringify(mensajes));
        input.value = "";
        renderMensajes();
      }

      document.getElementById("enviarBtn").addEventListener("click", enviarMensaje);
      document.getElementById("mensajeInput").addEventListener("keypress", e => {
        if (e.key === "Enter") enviarMensaje();
      });

      window.addEventListener("storage", e => {
        if (e.key === chatKey) {
          mensajes = JSON.parse(e.newValue || "[]");
          renderMensajes();
        }
      });

      renderMensajes();
    });
  </script>
</body>

</html>
