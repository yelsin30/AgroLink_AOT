<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Transportista | AgroLink</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Estilo personalizado -->
  <link rel="stylesheet" href="../css/Transporte/EstiloT.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <i class="fa-solid fa-tractor logo"></i>
    <div class="nav-icons">
      <button class="active" title="Inicio"><i class="fa-solid fa-house"></i></button>
      <button title="Solicitudes" onclick="location.href='solicitudes.html'"><i class="fa-solid fa-list"></i></button>
      <button title="Viajes" onclick="location.href='viajes.html'"><i class="fa-solid fa-truck"></i></button>
      <button title="Perfil" onclick="location.href='perfil.html'"><i class="fa-solid fa-user"></i></button>
    </div>
    <button class="logout-btn" id="logout">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Salir</span>
    </button>
  </aside>

  <!-- Contenido principal -->
  <main>
    <div class="content-container">
      <header class="mb-4">
        <h1><i class="fa-solid fa-gauge-high"></i> Panel de Control</h1>
        <p>Bienvenido, <span id="nombreUsuario">Transportista üë∑‚Äç‚ôÇÔ∏è</span></p>
      </header>

      <!-- Layout de dos columnas -->
      <div class="dashboard-layout">
        <!-- IZQUIERDA -->
        <div class="left-panel">
          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-road"></i></div>
              <div class="stat-text"><h4 id="viajesActivos">0</h4><span>Rutas activas</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-clock"></i></div>
              <div class="stat-text"><h4 id="viajesPendientes">0</h4><span>Pendientes</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-circle-check"></i></div>
              <div class="stat-text"><h4 id="viajesCompletados">0</h4><span>Completados</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-money-bill-trend-up"></i></div>
              <div class="stat-text"><h4>S/ <span id="ganancia">0</span></h4><span>Ganancia total</span></div>
            </div>
          </div>

          <!-- Mapa -->
          <div class="panel">
            <h5><i class="fa-solid fa-map-location-dot"></i> Rutas Activas</h5>
            <div id="map"></div>
            <p id="mapInfo" class="text-center mt-2 text-muted small">Cargando rutas...</p>
          </div>
        </div>

        <!-- DERECHA -->
        <div class="right-panel">
          <div class="perfil-box">
            <img src="../img/default-user.png" id="fotoPerfil" alt="Foto de perfil">
            <h5 id="nombrePerfil">Transportista</h5>
            <p><i class="fa-solid fa-id-badge"></i> <span id="placaPerfil">ABC-123</span></p>

            <!-- Estado -->
            <div class="estado-switch mt-3">
              <label class="form-check-label fw-semibold" for="estadoDisponible">
                <i class="fa-solid fa-signal"></i> Estado:
              </label>
              <div class="form-check form-switch ms-2">
                <input class="form-check-input" type="checkbox" id="estadoDisponible">
              </div>
            </div>
            <p id="estadoTexto" class="text-muted small mb-3">Desconectado</p>

            <!-- Calificaci√≥n -->
            <div class="rating-box mb-3">
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star-half-stroke text-warning"></i>
              <span class="ms-1 fw-semibold" id="calificacion">4.8 / 5</span>
            </div>

            <!-- Pr√≥ximo viaje -->
            <div class="next-trip-box p-3">
              <h6><i class="fa-solid fa-truck-fast"></i> Pr√≥ximo viaje</h6>
              <p id="proximoViaje" class="text-muted small">No hay viajes asignados.</p>
              <button id="btnIniciarRuta" class="btn btn-success btn-sm w-100 mt-2" disabled>
                <i class="fa-solid fa-route"></i> Iniciar ruta
              </button>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center mt-3 text-muted small">
        ¬© 2025 AgroLink. Todos los derechos reservados.
      </footer>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const usuario = JSON.parse(localStorage.getItem("agrolinkUsuario")) || {};
      const solicitudes = JSON.parse(localStorage.getItem("solicitudesAgroLink")) || [];

      // Perfil
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Transportista üë∑‚Äç‚ôÇÔ∏è";
      document.getElementById("nombrePerfil").textContent = usuario.nombre || "Transportista";
      document.getElementById("placaPerfil").textContent = usuario.placa || "No registrada";
      if (usuario.fotoPerfil) document.getElementById("fotoPerfil").src = usuario.fotoPerfil;

      // KPIs
      const activos = solicitudes.filter(s => /en\s*curso/i.test(s.estado || ""));
      const pendientes = solicitudes.filter(s => /pendiente/i.test(s.estado || ""));
      const completados = solicitudes.filter(s => /completado/i.test(s.estado || ""));
      document.getElementById("viajesActivos").textContent = activos.length;
      document.getElementById("viajesPendientes").textContent = pendientes.length;
      document.getElementById("viajesCompletados").textContent = completados.length;
      document.getElementById("ganancia").textContent =
        completados.reduce((a, s) => a + (parseFloat(s.pagoFinal || s.pago) || 0), 0).toFixed(2);

      // Mapa
      const map = L.map("map").setView([-9.19, -75.015], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
      const mapInfo = document.getElementById("mapInfo");

      // Estado disponible
      const estadoSwitch = document.getElementById("estadoDisponible");
      const estadoTexto = document.getElementById("estadoTexto");
      const estadoGuardado = localStorage.getItem("estadoDisponible");
      if (estadoGuardado === "true") {
        estadoSwitch.checked = true;
        estadoTexto.textContent = "üü¢ Disponible";
      } else {
        estadoTexto.textContent = "üî¥ Ocupado";
      }
      estadoSwitch.addEventListener("change", () => {
        const disp = estadoSwitch.checked;
        localStorage.setItem("estadoDisponible", disp);
        estadoTexto.textContent = disp ? "üü¢ Disponible" : "üî¥ Ocupado";
      });

      // Calificaci√≥n
      document.getElementById("calificacion").textContent = "4.8 / 5";

      // Pr√≥ximo viaje
      const proximo = solicitudes.find(s => /pendiente/i.test(s.estado || ""));
      const viajeBox = document.getElementById("proximoViaje");
      const btnRuta = document.getElementById("btnIniciarRuta");

      if (proximo) {
        viajeBox.innerHTML = `
          <strong>Origen:</strong> ${proximo.origen}<br>
          <strong>Destino:</strong> ${proximo.destino}<br>
          <strong>Fecha:</strong> ${proximo.fecha}
        `;
        btnRuta.disabled = false;

        btnRuta.addEventListener("click", async () => {
          const o = await obtenerCoords(proximo.origen);
          const d = await obtenerCoords(proximo.destino);
          if (o && d) {
            L.Routing.control({
              waypoints: [L.latLng(o), L.latLng(d)],
              lineOptions: { styles: [{ color: "#00b074", weight: 5 }] },
              showAlternatives: false,
              addWaypoints: false,
              createMarker: (i, wp) => L.marker(wp.latLng).bindPopup(
                i === 0 ? `üöö <b>Origen:</b> ${proximo.origen}` : `<b>Destino:</b> ${proximo.destino}`
              )
            }).addTo(map);
          }
        });
      } else {
        viajeBox.textContent = "No hay viajes asignados.";
        btnRuta.disabled = true;
      }

      // Mostrar rutas activas
      if (activos.length === 0) {
        mapInfo.textContent = "No hay rutas activas en este momento.";
      } else {
        mapInfo.textContent = `Mostrando ${activos.length} ruta(s) activa(s)...`;
        for (const s of activos) {
          const o = await obtenerCoords(s.origen);
          const d = await obtenerCoords(s.destino);
          if (o && d) {
            L.Routing.control({
              waypoints: [L.latLng(o), L.latLng(d)],
              lineOptions: { styles: [{ color: "#00b074", weight: 5 }] },
              addWaypoints: false,
              draggableWaypoints: false,
              showAlternatives: false,
              fitSelectedRoutes: true
            }).addTo(map);
          }
        }
      }

      // Cerrar sesi√≥n
      document.getElementById("logout").addEventListener("click", () => {
        alert("üëã Sesi√≥n cerrada correctamente. ¬°Hasta pronto, transportista!");
        localStorage.removeItem("agrolinkUsuario");
        localStorage.removeItem("agrolinkRol");
        window.location.href = "../index.html";
      });
    });

    async function obtenerCoords(ciudad) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ciudad + ", Per√∫")}`);
      const data = await res.json();
      return data[0] ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
    }
  </script>
</body>
</html>
