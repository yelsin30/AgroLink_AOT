<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Transportista | AgroLink</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <!-- Estilo personalizado -->
  <link rel="stylesheet" href="../css/Transporte/EstiloT.css">
</head>

<body>
  <!-- === SIDEBAR AGROLINK OFICIAL === -->
  <aside class="sidebar">
    <i class="fa-solid fa-tractor logo"></i>
    <div class="nav-icons">
      <button class="active" title="Inicio"><i class="fa-solid fa-house"></i></button>
      <button title="Solicitudes" onclick="location.href='solicitudes.html'"><i class="fa-solid fa-list"></i></button>
      <button title="Viajes" onclick="location.href='viajes.html'"><i class="fa-solid fa-truck"></i></button>
      <button title="Perfil" onclick="location.href='perfil.html'"><i class="fa-solid fa-user"></i></button>
    </div>
    <button class="logout-btn" id="logout">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Salir</span>
    </button>
  </aside>

  <!-- === CONTENIDO PRINCIPAL === -->
  <main>
    <div class="content-container">
      <!-- ENCABEZADO -->
      <header class="mb-4">
        <h1><i class="fa-solid fa-gauge-high"></i> Panel de Control</h1>
        <p>Bienvenido, <span id="nombreUsuario">Transportista üë∑‚Äç‚ôÇÔ∏è</span></p>
      </header>

      <div class="dashboard-layout d-flex gap-4 flex-wrap">
        <!-- IZQUIERDA -->
        <div class="left-panel flex-grow-1">
          <!-- KPIs -->
          <div class="stats-row mb-4">
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-truck"></i></div>
              <div>
                <h4 id="viajesTotales">0</h4><span>Viajes Totales</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-circle-check"></i></div>
              <div>
                <h4 id="completados">0</h4><span>Completados</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-road"></i></div>
              <div>
                <h4 id="distanciaTotal">0 km</h4><span>Distancia Estimada</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-money-bill-wave"></i></div>
              <div>
                <h4>S/ <span id="gananciaTotal">0.00</span></h4><span>Ganancia Total</span>
              </div>
            </div>
          </div>

          <!-- HISTORIAL DE VIAJES -->
          <div class="panel mb-4">
            <h5><i class="fa-solid fa-calendar-days"></i> Historial de Viajes</h5>
            <div id="calendario"></div>
          </div>
        </div>

        <!-- DERECHA -->
        <div class="right-panel" style="min-width:320px;">
          <!-- PERFIL -->
          <div class="perfil-box p-3 text-center shadow-sm rounded bg-white">
            <img src="../img/default-user.png" id="fotoPerfil" alt="Foto de perfil" class="rounded-circle mb-3"
              width="90" height="90">
            <h5 id="nombrePerfil" class="fw-bold mb-0">Transportista</h5>
            <p class="text-muted">
              <i class="fa-solid fa-id-badge"></i> <span id="placaPerfil">No registrada</span>
            </p>

            <div class="rating-box mb-3">
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star-half-stroke text-warning"></i>
              <span class="ms-1 fw-semibold" id="calificacion">4.8 / 5</span>
            </div>

            <button class="btn btn-success w-100" onclick="location.href='perfil.html'">
              <i class="fa-solid fa-user-gear"></i> Ver perfil completo
            </button>
          </div>

          <!-- CHATS -->
          <div class="chats-box mt-4 p-3 border rounded bg-white">
            <h6><i class="fa-solid fa-comments text-success"></i> Chats Activos (<span id="contadorChats">0</span>)</h6>
            <div id="listaChats" class="mt-2">
              <p class="text-muted small mb-0">No tienes chats activos.</p>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center mt-4 text-muted small">
        ¬© 2025 AgroLink. Todos los derechos reservados.
      </footer>
    </div>
  </main>

  <!-- === SCRIPT === -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // === 1Ô∏è‚É£ Verificar sesi√≥n ===
      const sesion = localStorage.getItem("agrolinkUsuario");
      if (!sesion) {
        window.location.href = "../login.html";
        return;
      }

      let usuario = JSON.parse(sesion);
      const usuariosLista = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
      const correoRef = (usuario.email || usuario.correo || "").toLowerCase();

      const idx = usuariosLista.findIndex(
        u => (u.email || u.correo || "").toLowerCase() === correoRef
      );
      if (idx !== -1) {
        usuario = usuariosLista[idx];
        localStorage.setItem("agrolinkUsuario", JSON.stringify(usuario));
      }

      // === 2Ô∏è‚É£ Mostrar datos del perfil ===
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Transportista üë∑‚Äç‚ôÇÔ∏è";
      document.getElementById("nombrePerfil").textContent = usuario.nombre || "Transportista";
      document.getElementById("placaPerfil").textContent = usuario.placa || "No registrada";
      if (usuario.fotoPerfil) document.getElementById("fotoPerfil").src = usuario.fotoPerfil;

      // === 3Ô∏è‚É£ Unificar datos de viajes ===
      const viajesMain = JSON.parse(localStorage.getItem("agrolinkViajes") || "[]");
      const solicitudes = JSON.parse(localStorage.getItem("solicitudesAgroLink") || "[]");
      const viajes = [...viajesMain, ...solicitudes];

      const nombreT = (usuario.nombre || "").trim().toLowerCase();
      const viajesTransp = viajes.filter(
        v => (v.transportista || "").trim().toLowerCase() === nombreT
      );

      // === 4Ô∏è‚É£ Calcular m√©tricas ===
      const enCurso = viajesTransp.filter(v => /curso/i.test(v.estado));
      const completados = viajesTransp.filter(v => /completado/i.test(v.estado));
      const cancelados = viajesTransp.filter(v => /cancelado/i.test(v.estado));

      // === üß≠ Calcular la distancia total usando los valores guardados desde viajes.html ===
      const totalDistancia = viajesTransp.reduce((acc, v) => {
        // Si el viaje tiene la distancia guardada (desde viajes.html), √∫sala
        if (v.distancia && !isNaN(parseFloat(v.distancia))) {
          return acc + parseFloat(v.distancia);
        }

        // Si no tiene distancia guardada, intenta buscarla en solicitudesAgroLink
        const solicitudMatch = solicitudes.find(s => s.id === v.id && s.distancia);
        if (solicitudMatch) {
          return acc + parseFloat(solicitudMatch.distancia);
        }

        // Si no hay registro, deja la distancia como 0
        return acc;
      }, 0);


      const totalGanancia = completados.reduce(
        (acc, v) => acc + (parseFloat(v.pagoFinal || v.pago) || 0),
        0
      );

      // === 5Ô∏è‚É£ Mostrar KPIs ===
      document.getElementById("viajesTotales").textContent = viajesTransp.length;
      document.getElementById("completados").textContent = completados.length;
      document.getElementById("distanciaTotal").textContent = `${totalDistancia.toFixed(0)} km`;
      document.getElementById("gananciaTotal").textContent = totalGanancia.toFixed(2);

      // === 6Ô∏è‚É£ Renderizar calendario ===
      const calendarEl = document.getElementById("calendario");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "es",
        height: 550,
        headerToolbar: { left: "prev,next today", center: "title", right: "" },
        events: viajesTransp.map(v => ({
          title: `${v.origen || "?"} ‚Üí ${v.destino || "?"}`,
          start: v.fecha,
          backgroundColor:
            /completado/i.test(v.estado)
              ? "#00b074"
              : /curso/i.test(v.estado)
                ? "#ffb703"
                : "#d9534f",
          borderColor: "transparent",
          extendedProps: v
        })),
        eventClick: info => {
          const v = info.event.extendedProps;
          const pago = parseFloat(v.pagoFinal || v.pago || 0).toFixed(2);
          alert(
            `üì¶ ${v.origen || "?"} ‚Üí ${v.destino || "?"}\n` +
            `üìÖ ${v.fecha || "-"}\n` +
            `üí∞ S/ ${pago}\n` +
            `üöö Estado: ${v.estado || "Sin estado"}`
          );
        }
      });
      calendar.render();

      // === 7Ô∏è‚É£ Chats activos ===
      document.getElementById("contadorChats").textContent = enCurso.length;
      document.getElementById("listaChats").innerHTML = enCurso.length
        ? enCurso.map(s => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
          <div>
            <strong>${s.tipo || "Carga"}</strong><br>
            <small class="text-muted">${s.origen || "?"} ‚Üí ${s.destino || "?"}</small>
          </div>
          <button class="btn btn-sm btn-success"
            onclick="window.location.href='./Comunicacion/chatT.html?id=${encodeURIComponent(s.id)}&productor=${encodeURIComponent(s.productor || '')}'">
            <i class="fa-solid fa-comments"></i> Chat
          </button>
        </div>
      `).join("")
        : `<p class="text-muted small mb-0">No tienes chats activos.</p>`;

      // === 8Ô∏è‚É£ Logout ===
      document.getElementById("logout").addEventListener("click", () => {
        const lista = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
        const i = lista.findIndex(u => (u.email || u.correo || "").toLowerCase() === correoRef);
        if (i !== -1) lista[i].sesionActiva = false;
        localStorage.setItem("agrolinkUsuarios", JSON.stringify(lista));
        localStorage.removeItem("agrolinkUsuario");
        localStorage.removeItem("agrolinkRol");
        alert("üëã Sesi√≥n cerrada correctamente. ¬°Hasta pronto!");
        window.location.href = "../index.html";
      });
    });
  </script>


</body>

</html>