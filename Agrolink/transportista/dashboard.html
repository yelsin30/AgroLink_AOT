<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Transportista | AgroLink</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <!-- Estilo personalizado -->
  <link rel="stylesheet" href="../css/Transporte/EstiloT.css">
</head>

<body>
  <!-- === SIDEBAR AGROLINK OFICIAL === -->
  <aside class="sidebar">
    <i class="fa-solid fa-tractor logo"></i>
    <div class="nav-icons">
      <button class="active" title="Inicio"><i class="fa-solid fa-house"></i></button>
      <button title="Solicitudes" onclick="location.href='solicitudes.html'"><i class="fa-solid fa-list"></i></button>
      <button title="Viajes" onclick="location.href='viajes.html'"><i class="fa-solid fa-truck"></i></button>
      <button title="Perfil" onclick="location.href='perfil.html'"><i class="fa-solid fa-user"></i></button>
    </div>
    <button class="logout-btn" id="logout">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Salir</span>
    </button>
  </aside>

  <!-- === CONTENIDO PRINCIPAL === -->
  <main>
    <div class="content-container">
      <!-- ENCABEZADO -->
      <header class="mb-4">
        <h1><i class="fa-solid fa-gauge-high"></i> Panel de Control</h1>
        <p>Bienvenido, <span id="nombreUsuario">Transportista üë∑‚Äç‚ôÇÔ∏è</span></p>
      </header>

      <div class="dashboard-layout d-flex gap-4 flex-wrap">
        <!-- IZQUIERDA -->
        <div class="left-panel flex-grow-1">
          <!-- KPIs -->
          <div class="stats-row mb-4">
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-truck"></i></div>
              <div><h4 id="viajesTotales">0</h4><span>Viajes Totales</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-circle-check"></i></div>
              <div><h4 id="completados">0</h4><span>Completados</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-road"></i></div>
              <div><h4 id="distanciaTotal">0 km</h4><span>Distancia Estimada</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fa-solid fa-money-bill-wave"></i></div>
              <div><h4>S/ <span id="gananciaTotal">0.00</span></h4><span>Ganancia Total</span></div>
            </div>
          </div>

          <!-- HISTORIAL DE VIAJES -->
          <div class="panel mb-4">
            <h5><i class="fa-solid fa-calendar-days"></i> Historial de Viajes</h5>
            <div id="calendario"></div>
          </div>
        </div>

        <!-- DERECHA -->
        <div class="right-panel" style="min-width:320px;">
          <!-- PERFIL -->
          <div class="perfil-box p-3 text-center shadow-sm rounded bg-white">
            <img src="../img/default-user.png" id="fotoPerfil" alt="Foto de perfil"
              class="rounded-circle mb-3" width="90" height="90">
            <h5 id="nombrePerfil" class="fw-bold mb-0">Transportista</h5>
            <p class="text-muted">
              <i class="fa-solid fa-id-badge"></i> <span id="placaPerfil">No registrada</span>
            </p>

            <div class="rating-box mb-3">
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star text-warning"></i>
              <i class="fa-solid fa-star-half-stroke text-warning"></i>
              <span class="ms-1 fw-semibold" id="calificacion">4.8 / 5</span>
            </div>

            <button class="btn btn-success w-100" onclick="location.href='perfil.html'">
              <i class="fa-solid fa-user-gear"></i> Ver perfil completo
            </button>
          </div>

          <!-- CHATS -->
          <div class="chats-box mt-4 p-3 border rounded bg-white">
            <h6><i class="fa-solid fa-comments text-success"></i> Chats Activos (<span id="contadorChats">0</span>)</h6>
            <div id="listaChats" class="mt-2">
              <p class="text-muted small mb-0">No tienes chats activos.</p>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center mt-4 text-muted small">
        ¬© 2025 AgroLink. Todos los derechos reservados.
      </footer>
    </div>
  </main>

  <!-- === SCRIPT === -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const usuario = JSON.parse(localStorage.getItem("agrolinkUsuario") || "{}");
      const solicitudes = JSON.parse(localStorage.getItem("solicitudesAgroLink") || "[]");

      // Perfil
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Transportista üë∑‚Äç‚ôÇÔ∏è";
      document.getElementById("nombrePerfil").textContent = usuario.nombre || "Transportista";
      document.getElementById("placaPerfil").textContent = usuario.placa || "No registrada";
      if (usuario.fotoPerfil) document.getElementById("fotoPerfil").src = usuario.fotoPerfil;

      const nombreTransp = (usuario.nombre || "").toLowerCase();
      const asignados = solicitudes.filter(s => (s.transportista || "").toLowerCase() === nombreTransp);

      // KPIs
      const completados = asignados.filter(s => /completado/i.test(s.estado));
      const totalGanado = completados.reduce((a, s) => a + (parseFloat(s.pagoFinal || s.pago) || 0), 0);
      const totalDist = asignados.length * 120;

      document.getElementById("viajesTotales").textContent = asignados.length;
      document.getElementById("completados").textContent = completados.length;
      document.getElementById("distanciaTotal").textContent = `${totalDist} km`;
      document.getElementById("gananciaTotal").textContent = totalGanado.toFixed(2);

      // Calendario
      const calendarEl = document.getElementById("calendario");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "es",
        height: 550,
        headerToolbar: { left: "prev,next today", center: "title", right: "" },
        events: completados.map(v => ({
          title: `${v.origen} ‚Üí ${v.destino}`,
          start: v.fecha,
          backgroundColor: "#00b074",
          borderColor: "#00b074",
          extendedProps: v
        })),
        eventClick: info => {
          const v = info.event.extendedProps;
          alert(`üì¶ ${v.origen} ‚Üí ${v.destino}\nüìÖ ${v.fecha}\nüí∞ S/ ${(v.pagoFinal || v.pago).toFixed(2)}\nüë®‚Äçüåæ ${v.productor}`);
        }
      });
      calendar.render();

      // Chats
      const enCurso = asignados.filter(s => /curso/i.test(s.estado));
      document.getElementById("contadorChats").textContent = enCurso.length;
      document.getElementById("listaChats").innerHTML = enCurso.length
        ? enCurso.map(s => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div><strong>${s.tipo || "Carga"}</strong><br><small class="text-muted">${s.origen} ‚Üí ${s.destino}</small></div>
            <button class="btn btn-sm btn-success" onclick="window.location.href='./Comunicacion/chatT.html?id=${encodeURIComponent(s.id)}&productor=${encodeURIComponent(s.productor || '')}'">
              <i class="fa-solid fa-comments"></i> Chat
            </button>
          </div>
        `).join("")
        : `<p class="text-muted small mb-0">No tienes chats activos.</p>`;

      // Logout
      document.getElementById("logout").addEventListener("click", () => {
        alert("üëã Sesi√≥n cerrada correctamente. ¬°Hasta pronto!");
        localStorage.clear();
        window.location.href = "../index.html";
      });
    });
  </script>
</body>
</html>
