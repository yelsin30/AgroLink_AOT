<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solicitudes disponibles | AgroLink</title>

  <link rel="icon" href="../img/logo.png" type="image/png">
  <link rel="stylesheet" href="../css/Transporte/EstiloSoli.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo-section"><i class="fa-solid fa-tractor"></i></div>
      <nav class="nav-links">
        <a href="dashboard.html"><i class="fa-solid fa-home"></i></a>
        <a href="solicitudes.html" class="active"><i class="fa-solid fa-list"></i></a>
        <a href="viajes.html"><i class="fa-solid fa-truck"></i></a>
        <a href="perfil.html"><i class="fa-solid fa-user"></i></a>
      </nav>
      <div class="help-section">
        <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i><span>Salir</span></a>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h1>Solicitudes disponibles</h1>
        <p>Selecciona una solicitud para ver m√°s detalles o aceptarla.</p>
      </header>

      <section class="filters" id="filtros">
        <select id="filterTipo"><option value="">Tipo (Todos)</option></select>
        <input id="filterOrigen" placeholder="Origen (ciudad)" />
        <input id="filterDestino" placeholder="Destino (ciudad)" />
        <input id="filterMinPago" type="number" placeholder="Pago m√≠nimo S/" min="0" />
        <input id="filterMaxPago" type="number" placeholder="Pago m√°ximo S/" min="0" />
        <button class="btn-filter" id="btnAplicar">Aplicar</button>
        <button class="btn-reset" id="btnReset">Restablecer</button>
      </section>

      <section class="solicitudes-list" id="listaSolicitudes">
        <p class="no-results">No hay solicitudes disponibles por ahora.</p>
      </section>
    </main>
  </div>

  <footer class="footer">
    <p>¬© 2025 AgroLink. Todos los derechos reservados.</p>
  </footer>

  <div class="panel-overlay" id="overlay"></div>
  <div class="panel" id="panelDetalle">
    <div class="panel-header">
      <h2 id="detalleTipo"></h2>
      <p id="detalleProductor" style="color:#555; font-weight:500;"></p>
    </div>
    <div class="panel-content">
      <div class="tel-header"><i class="fa-solid fa-phone"></i> Tel√©fonos</div>
      <p id="detalleTelefono"></p>
      <p><strong>Calificaci√≥n:</strong> ‚≠ê <span id="detalleCalificacion"></span></p>
      <p><strong>Origen:</strong> <span id="detalleOrigen"></span></p>
      <p><strong>Destino:</strong> <span id="detalleDestino"></span></p>
      <p><strong>Peso:</strong> <span id="detallePeso"></span> kg</p>
      <p><strong>Pago:</strong> S/ <span id="detallePago"></span></p>
      <p><strong>Fecha:</strong> <span id="detalleFecha"></span></p>
      <div id="map"></div>
    </div>
    <div class="panel-buttons">
      <button class="btn btn-accept" id="btnAceptar"><i class="fa-solid fa-check"></i> Aceptar</button>
      <button class="btn btn-denunciar" id="btnDenunciar"><i class="fa-solid fa-flag"></i> Denunciar</button>
      <button class="btn btn-close" id="btnCerrar">Cerrar</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="../js/toast.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // === üîê Verificaci√≥n y sincronizaci√≥n de sesi√≥n ===
      const sesionGuardada = localStorage.getItem("agrolinkUsuario");
      if (!sesionGuardada) {
        window.location.href = "../login.html";
        return;
      }
      let usuario = JSON.parse(sesionGuardada);
      let usuariosLista = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
      const idx = usuariosLista.findIndex(u => (u.email || u.correo) === (usuario.email || usuario.correo));
      if (idx !== -1) {
        usuario = usuariosLista[idx];
        localStorage.setItem("agrolinkUsuario", JSON.stringify(usuario));
      }

      // === Variables principales ===
      let db = JSON.parse(localStorage.getItem("solicitudesAgroLink")) || [];
      const contenedor = document.getElementById("listaSolicitudes");
      const overlay = document.getElementById("overlay");
      const panel = document.getElementById("panelDetalle");
      const btnCerrar = document.getElementById("btnCerrar");
      const btnAceptar = document.getElementById("btnAceptar");
      const btnDenunciar = document.getElementById("btnDenunciar");

      const filterTipo = document.getElementById("filterTipo");
      const filterOrigen = document.getElementById("filterOrigen");
      const filterDestino = document.getElementById("filterDestino");
      const filterMinPago = document.getElementById("filterMinPago");
      const filterMaxPago = document.getElementById("filterMaxPago");
      const btnAplicar = document.getElementById("btnAplicar");
      const btnReset = document.getElementById("btnReset");

      let map = null;
      let routing = null;
      let solicitudActual = null;

      function guardarDB() {
        localStorage.setItem("solicitudesAgroLink", JSON.stringify(db));
      }

      function poblarTipos() {
        const tipos = Array.from(new Set(db.map(s => s.tipo).filter(Boolean)));
        filterTipo.innerHTML = '<option value="">Tipo (Todos)</option>';
        tipos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          filterTipo.appendChild(opt);
        });
      }

      function renderList() {
        const pendientes = db.filter(s => s.estado === "Pendiente");
        const tipoVal = filterTipo.value.trim();
        const origenVal = filterOrigen.value.trim().toLowerCase();
        const destinoVal = filterDestino.value.trim().toLowerCase();
        const minPago = parseFloat(filterMinPago.value) || null;
        const maxPago = parseFloat(filterMaxPago.value) || null;

        let resultados = pendientes.filter(s => {
          if (tipoVal && s.tipo !== tipoVal) return false;
          if (origenVal && !`${s.origen || ''}`.toLowerCase().includes(origenVal)) return false;
          if (destinoVal && !`${s.destino || ''}`.toLowerCase().includes(destinoVal)) return false;
          const pago = parseFloat(s.pago) || 0;
          if (minPago !== null && pago < minPago) return false;
          if (maxPago !== null && pago > maxPago) return false;
          return true;
        });

        contenedor.innerHTML = resultados.length
          ? ""
          : '<p class="no-results">No se encontraron solicitudes que coincidan con los filtros.</p>';

        resultados.forEach(s => {
          const card = document.createElement("div");
          card.classList.add("card");
          card.innerHTML = `
            <h3><i class="fa-solid fa-seedling"></i> ${s.tipo || 'Sin tipo'}</h3>
            <p><strong>Productor:</strong> ${s.productor || 'Desconocido'}</p>
            <p><strong>Origen:</strong> ${s.origen || '---'}</p>
            <p><strong>Destino:</strong> ${s.destino || '---'}</p>
            <p><strong>Pago:</strong> S/ ${s.pago || '0'}</p>
            <button class="btn-ver">Ver detalles</button>
          `;
          card.querySelector(".btn-ver").addEventListener("click", () => abrirPanel(s));
          contenedor.appendChild(card);
        });
      }

      async function abrirPanel(s) {
        solicitudActual = s;
        if (!solicitudActual || solicitudActual.estado !== "Pendiente") {
          showToast("Esta solicitud ya no est√° disponible.", "info");
          renderList();
          return;
        }

        panel.classList.add("show");
        overlay.style.display = "block";
        document.body.style.overflow = "hidden";

        document.getElementById("detalleTipo").textContent = s.tipo || "Sin tipo";
        document.getElementById("detalleProductor").textContent = s.productor || "Desconocido";
        document.getElementById("detalleTelefono").innerHTML = `
          <strong>Principal:</strong> ${s.telefonoPrincipal || s.telefono || "No registrado"}<br>
          <strong>Alternativo:</strong> ${s.telefonoAlternativo || s.contactoAlt || "No registrado"}
        `;
        document.getElementById("detalleCalificacion").textContent = s.calificacion || "4.8";
        document.getElementById("detalleOrigen").textContent = s.origen || '---';
        document.getElementById("detalleDestino").textContent = s.destino || '---';
        document.getElementById("detallePeso").textContent = s.peso || '---';
        document.getElementById("detallePago").textContent = s.pago || '0';
        document.getElementById("detalleFecha").textContent = s.fecha || '';

        if (map) map.remove();
        map = L.map("map").setView([-9.19, -75.015], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        const origen = await obtenerCoords(s.origen);
        const destino = await obtenerCoords(s.destino);
        if (origen && destino) {
          routing = L.Routing.control({
            waypoints: [L.latLng(origen), L.latLng(destino)],
            lineOptions: { styles: [{ color: "#00b074", weight: 5 }] },
            showAlternatives: false,
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            createMarker: (i, wp) =>
              L.marker(wp.latLng).bindPopup(i === 0 ? `üöú <b>Origen:</b> ${s.origen}` : `<b>Destino:</b> ${s.destino}`)
          }).addTo(map);
        }
      }

      async function obtenerCoords(ciudad) {
        if (!ciudad) return null;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ciudad + ", Per√∫")}`);
          const data = await res.json();
          return data[0] ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        } catch { return null; }
      }

      btnCerrar.addEventListener("click", () => {
        panel.classList.remove("show");
        document.body.style.overflow = "auto";
        setTimeout(() => (overlay.style.display = "none"), 400);
      });

      btnAceptar.addEventListener("click", () => {
        if (!solicitudActual || solicitudActual.estado !== "Pendiente") {
          showToast("La solicitud ya no est√° disponible.", "info");
          renderList();
          return;
        }
        solicitudActual.estado = "En curso";
        solicitudActual.transportista = usuario.nombre || "Transportista";
        solicitudActual.transportistaId = usuario.id || null;
        guardarDB();

        const chatKey = `chat_${solicitudActual.id || solicitudActual.fecha}`;
        let mensajes = JSON.parse(localStorage.getItem(chatKey) || "[]");
        if (!mensajes.some(m => m.tipo === "autoInicio")) {
          mensajes.push({
            remitente: usuario.nombre || "Transportista",
            rol: "transportista",
            texto: "üöö ¬°Hola! Estoy en camino al punto de recojo.",
            fecha: new Date().toISOString(),
            tipo: "autoInicio"
          });
          localStorage.setItem(chatKey, JSON.stringify(mensajes));
        }

        showToast("‚úÖ Has aceptado la solicitud.", "success");
        cerrarYActualizar();
      });

      btnDenunciar.addEventListener("click", () => {
        if (!solicitudActual || solicitudActual.estado !== "Pendiente") {
          showToast("La solicitud ya no est√° disponible.", "info");
          renderList();
          return;
        }
        const motivo = prompt("Indica el motivo de la denuncia (opcional):");
        if (motivo === null && !confirm("¬øDeseas denunciar sin motivo?")) return;

        solicitudActual.estado = "Denunciada";
        guardarDB();

        const denuncias = JSON.parse(localStorage.getItem("denunciasAgroLink") || "[]");
        denuncias.push({
          id: `den_${Date.now()}`,
          solicitudId: solicitudActual.id || solicitudActual.fecha,
          productor: solicitudActual.productor || null,
          tipo: solicitudActual.tipo || null,
          motivo: motivo || "",
          denunciadoPor: usuario.nombre || null,
          fecha: new Date().toISOString()
        });
        localStorage.setItem("denunciasAgroLink", JSON.stringify(denuncias));

        showToast("üö© Solicitud denunciada y removida de la lista.", "error");
        cerrarYActualizar();
      });

      function cerrarYActualizar() {
        panel.classList.remove("show");
        document.body.style.overflow = "auto";
        setTimeout(() => (overlay.style.display = "none"), 400);
        setTimeout(() => {
          db = JSON.parse(localStorage.getItem("solicitudesAgroLink")) || [];
          poblarTipos(); renderList();
        }, 500);
      }

      btnAplicar.addEventListener("click", e => { e.preventDefault(); renderList(); });
      btnReset.addEventListener("click", e => {
        e.preventDefault();
        [filterTipo, filterOrigen, filterDestino, filterMinPago, filterMaxPago].forEach(f => f.value = "");
        renderList();
      });

      // === üîö Logout persistente ===
      document.getElementById("logout").addEventListener("click", e => {
        e.preventDefault();
        const usuarios = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];
        const idx = usuarios.findIndex(u => (u.email || u.correo) === (usuario.email || usuario.correo));
        if (idx !== -1) {
          usuarios[idx].sesionActiva = false;
          localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuarios));
        }
        localStorage.removeItem("agrolinkUsuario");
        localStorage.removeItem("agrolinkRol");
        showToast("üëã Sesi√≥n cerrada correctamente", "info");
        setTimeout(() => window.location.href = "../index.html", 800);
      });

      poblarTipos();
      renderList();
    });
  </script>
</body>
</html>
