<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solicitudes disponibles | AgroLink</title>

  <link rel="icon" href="../img/logo.png" type="image/png">
  <link rel="stylesheet" href="../css/Transporte/EstiloSoli.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo-section"><i class="fa-solid fa-tractor"></i></div>
      <nav class="nav-links">
        <a href="dashboard.html"><i class="fa-solid fa-home"></i></a>
        <a href="solicitudes.html" class="active"><i class="fa-solid fa-list"></i></a>
        <a href="viajes.html"><i class="fa-solid fa-truck"></i></a>
        <a href="perfil.html"><i class="fa-solid fa-user"></i></a>
      </nav>
      <div class="help-section">
        <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i><span>Salir</span></a>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h1>Solicitudes disponibles</h1>
        <p>Selecciona una solicitud para ver m√°s detalles o aceptarla.</p>
      </header>

      <section class="filters" id="filtros">
        <select id="filterTipo">
          <option value="">Tipo (Todos)</option>
        </select>
        <input id="filterOrigen" placeholder="Origen (ciudad)" />
        <input id="filterDestino" placeholder="Destino (ciudad)" />
        <input id="filterMinPago" type="number" placeholder="Pago m√≠nimo S/" min="0" />
        <input id="filterMaxPago" type="number" placeholder="Pago m√°ximo S/" min="0" />
        <button class="btn-filter" id="btnAplicar">Aplicar</button>
        <button class="btn-reset" id="btnReset">Restablecer</button>
      </section>

      <section class="solicitudes-list" id="listaSolicitudes">
        <p class="no-results">No hay solicitudes disponibles por ahora.</p>
      </section>
    </main>
  </div>

  <footer class="footer">
    <p>¬© 2025 AgroLink. Todos los derechos reservados.</p>
  </footer>

  <!-- Modal de Postulaci√≥n SIMPLE (YA NO SE USA PARA CONTRAOFERTA) -->
  <div class="panel-overlay" id="overlayPostular"></div>

  <div class="panel" id="panelPostular" style="max-width:480px">
    <div class="panel-header">
      <h2>Postular a solicitud</h2>
    </div>

    <div class="panel-content">
      <p><strong>Solicitud:</strong> <span id="postularTipo"></span></p>
      <p><strong>Productor:</strong> <span id="postularProductor"></span></p>

      <label><strong>Oferta propuesta (S/)</strong></label>
      <input type="number" id="postularOferta" min="0" class="input" placeholder="Ej. 250">

      <label><strong>Mensaje al productor</strong></label>
      <textarea id="postularMensaje" placeholder="Opcional..."></textarea>
    </div>

    <div class="panel-buttons">
      <button class="btn btn-accept" id="btnEnviarPostulacionSimple">
        <i class="fa-solid fa-paper-plane"></i> Enviar Postulaci√≥n
      </button>
      <button class="btn btn-close" id="btnCerrarPostular">Cancelar</button>
    </div>
  </div>

  <!-- Modal oficial de postulaci√≥n / contraoferta -->
  <div class="panel-overlay" id="modalPostulacionOverlay"></div>

  <div class="panel small-panel" id="modalPostulacion">
    <div class="panel-header">
      <h2>Postular a la solicitud</h2>
      <button class="btn-close" id="cerrarPostulacion"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="panel-content">
      <label>Monto ofrecido (S/)</label>
      <input type="number" id="ofertaMonto" min="0" step="0.1" placeholder="Ej. 450.00" />
      <small style="color:#64748b;">Si est√° vac√≠o, se usa el pago sugerido.</small>

      <label style="margin-top:10px;">Mensaje para el productor</label>
      <textarea id="ofertaMensaje" rows="3" placeholder="Ej: Tengo experiencia en esta ruta."></textarea>
    </div>

    <div class="panel-buttons">
      <button class="btn btn-accept" id="btnEnviarPostulacion">
        <i class="fa-solid fa-paper-plane"></i> Enviar postulaci√≥n
      </button>
      <button class="btn btn-close" id="btnCancelarPostulacion">Cancelar</button>
    </div>
  </div>

  <!-- PANEL DETALLE -->
  <div class="panel-overlay" id="overlay"></div>

  <div class="panel" id="panelDetalle">
    <div class="panel-header">
      <h2 id="detalleTipo">Tipo</h2>
      <p id="detalleProductor" style="color:#555; font-weight:500;"></p>
    </div>

    <div class="panel-content">
      <p><strong>Tel√©fono principal:</strong> <span id="detalleTelefono"></span></p>
      <p><strong>Calificaci√≥n:</strong> ‚≠ê <span id="detalleCalificacion"></span></p>
      <p><strong>Origen:</strong> <span id="detalleOrigen"></span></p>
      <p><strong>Destino:</strong> <span id="detalleDestino"></span></p>
      <p><strong>Peso:</strong> <span id="detallePeso"></span> kg</p>
      <p><strong>Pago sugerido:</strong> S/ <span id="detallePago"></span></p>
      <p><strong>Fecha:</strong> <span id="detalleFecha"></span></p>

      <h4 style="margin-top:1rem;">Ruta estimada</h4>
      <div id="map" style="height:260px;border-radius:10px;"></div>
    </div>

    <div class="panel-buttons">
      <button class="btn btn-accept" id="btnPostular">
        <i class="fa-solid fa-handshake"></i> Postular
      </button>

      <button class="btn btn-denunciar" id="btnDenunciar">
        <i class="fa-solid fa-flag"></i> Denunciar
      </button>

      <button class="btn btn-close" id="btnCerrar">Cerrar</button>
    </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="../js/toast.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // === üîê Sesi√≥n y sincronizaci√≥n (igual que ten√≠as) ===
      const sesionGuardada = localStorage.getItem("agrolinkUsuario");
      if (!sesionGuardada) {
        window.location.href = "../login.html";
        return;
      }
      let usuario = JSON.parse(sesionGuardada);
      let usuariosLista = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
      const idxUser = usuariosLista.findIndex(u => (u.email || u.correo) === (usuario.email || usuario.correo));
      if (idxUser !== -1) {
        usuario = usuariosLista[idxUser];
        localStorage.setItem("agrolinkUsuario", JSON.stringify(usuario));
      }

      // === Variables principales ===
      let db = JSON.parse(localStorage.getItem("solicitudesAgroLink")) || [];
      const contenedor = document.getElementById("listaSolicitudes");
      const overlay = document.getElementById("overlay");
      const panel = document.getElementById("panelDetalle");
      const btnCerrar = document.getElementById("btnCerrar");
      const btnDenunciar = document.getElementById("btnDenunciar");
      const btnPostular = document.getElementById("btnPostular");

      // Modal de postulaci√≥n
      const modalPostulacion = document.getElementById("modalPostulacion");
      const modalPostulacionOverlay = document.getElementById("modalPostulacionOverlay");
      const cerrarPostulacion = document.getElementById("cerrarPostulacion");
      const btnCancelarPostulacion = document.getElementById("btnCancelarPostulacion");
      const btnEnviarPostulacion = document.getElementById("btnEnviarPostulacion");
      const ofertaMonto = document.getElementById("ofertaMonto");
      const ofertaMensaje = document.getElementById("ofertaMensaje");

      const filterTipo = document.getElementById("filterTipo");
      const filterOrigen = document.getElementById("filterOrigen");
      const filterDestino = document.getElementById("filterDestino");
      const filterMinPago = document.getElementById("filterMinPago");
      const filterMaxPago = document.getElementById("filterMaxPago");
      const btnAplicar = document.getElementById("btnAplicar");
      const btnReset = document.getElementById("btnReset");

      let map = null;
      let routing = null;
      let solicitudActual = null;

      function guardarDB() {
        localStorage.setItem("solicitudesAgroLink", JSON.stringify(db));
      }

      function poblarTipos() {
        const tipos = Array.from(new Set(db.map(s => s.tipo).filter(Boolean)));
        filterTipo.innerHTML = '<option value="">Tipo (Todos)</option>';
        tipos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          filterTipo.appendChild(opt);
        });
      }

      function renderList() {
        const pendientes = db.filter(s => s.estado === "Pendiente");
        const tipoVal = filterTipo.value.trim();
        const origenVal = filterOrigen.value.trim().toLowerCase();
        const destinoVal = filterDestino.value.trim().toLowerCase();
        const minPago = parseFloat(filterMinPago.value) || null;
        const maxPago = parseFloat(filterMaxPago.value) || null;

        let resultados = pendientes.filter(s => {
          if (tipoVal && s.tipo !== tipoVal) return false;
          if (origenVal && !`${s.origen || ''}`.toLowerCase().includes(origenVal)) return false;
          if (destinoVal && !`${s.destino || ''}`.toLowerCase().includes(destinoVal)) return false;
          const pago = parseFloat(s.pago) || 0;
          if (minPago !== null && pago < minPago) return false;
          if (maxPago !== null && pago > maxPago) return false;
          return true;
        });
        // === Notificaciones de postulaci√≥n aceptada ===
        const notifs = JSON.parse(localStorage.getItem("agrolinkNotificaciones") || "[]");
        const miId = usuario.id || usuario.email || usuario.correo || usuario.nombre;

        const mias = notifs.filter(n => !n.leida && n.paraRol === "transportista" && n.paraId === miId);

        if (mias.length > 0) {
          // Si tienes showToast:
          // mias.forEach(n => showToast(n.mensaje, "success"));
          // Si no, al menos un alert:
          alert(mias[0].mensaje);

          // Marcarlas como le√≠das
          notifs.forEach(n => {
            if (n.paraId === miId && n.paraRol === "transportista") n.leida = true;
          });
          localStorage.setItem("agrolinkNotificaciones", JSON.stringify(notifs));
        }

        contenedor.innerHTML = resultados.length
          ? ""
          : '<p class="no-results">No se encontraron solicitudes que coincidan con los filtros.</p>';

        resultados.forEach(s => {
          const card = document.createElement("div");
          card.classList.add("card");

          const yaPostule =
            Array.isArray(s.postulaciones) &&
            s.postulaciones.some(p => (p.id === (usuario.id || usuario.email || usuario.correo || usuario.nombre)));

          card.innerHTML = `
            <h3><i class="fa-solid fa-seedling"></i> ${s.tipo || 'Sin tipo'}</h3>
            <p><strong>Productor:</strong> ${s.productor || 'Desconocido'}</p>
            <p><strong>Origen:</strong> ${s.origen || '---'}</p>
            <p><strong>Destino:</strong> ${s.destino || '---'}</p>
            <p><strong>Pago sugerido:</strong> S/ ${s.pago || '0'}</p>
            <p><strong>Postulaci√≥n:</strong> ${yaPostule ? 'Ya postulaste ‚úÖ' : 'A√∫n no has postulado'}</p>
            <button class="btn-ver">Ver detalles</button>
          `;
          card.querySelector(".btn-ver").addEventListener("click", () => abrirPanel(s));
          contenedor.appendChild(card);
        });
      }

      async function abrirPanel(s) {
        solicitudActual = s;
        if (!solicitudActual || solicitudActual.estado !== "Pendiente") {
          showToast("Esta solicitud ya no est√° disponible.", "info");
          renderList();
          return;
        }

        panel.classList.add("show");
        overlay.style.display = "block";
        document.body.style.overflow = "hidden";

        document.getElementById("detalleTipo").textContent = s.tipo || "Sin tipo";
        document.getElementById("detalleProductor").textContent = s.productor || "Desconocido";
        document.getElementById("detalleTelefono").innerHTML = `
          <strong>Principal:</strong> ${s.telefonoPrincipal || s.telefono || "No registrado"}<br>
          <strong>Alternativo:</strong> ${s.telefonoAlternativo || s.contactoAlt || "No registrado"}
        `;
        document.getElementById("detalleCalificacion").textContent = s.calificacion || "4.8";
        document.getElementById("detalleOrigen").textContent = s.origen || '---';
        document.getElementById("detalleDestino").textContent = s.destino || '---';
        document.getElementById("detallePeso").textContent = s.peso || '---';
        document.getElementById("detallePago").textContent = s.pago || '0';
        document.getElementById("detalleFecha").textContent = s.fecha || '';

        if (map) map.remove();
        map = L.map("map").setView([-9.19, -75.015], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        const origen = await obtenerCoords(s.origen);
        const destino = await obtenerCoords(s.destino);
        if (origen && destino) {
          routing = L.Routing.control({
            waypoints: [L.latLng(origen), L.latLng(destino)],
            lineOptions: { styles: [{ color: "#00b074", weight: 5 }] },
            showAlternatives: false,
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            createMarker: (i, wp) =>
              L.marker(wp.latLng).bindPopup(i === 0 ? `üöú <b>Origen:</b> ${s.origen}` : `<b>Destino:</b> ${s.destino}`)
          }).addTo(map);
        }
      }

      async function obtenerCoords(ciudad) {
        if (!ciudad) return null;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ciudad + ", Per√∫")}`);
          const data = await res.json();
          return data[0] ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        } catch { return null; }
      }

      btnCerrar.addEventListener("click", () => {
        panel.classList.remove("show");
        document.body.style.overflow = "auto";
        setTimeout(() => (overlay.style.display = "none"), 400);
      });

      // === üîπ Abrir modal de postulaci√≥n ===
      btnPostular.addEventListener("click", () => {
        if (!solicitudActual || solicitudActual.estado !== "Pendiente") {
          showToast("La solicitud ya no est√° disponible.", "info");
          return;
        }
        ofertaMonto.value = "";
        ofertaMensaje.value = "";
        modalPostulacionOverlay.style.display = "block";
        modalPostulacion.classList.add("show");
      });

      function cerrarModalPostulacion() {
        modalPostulacion.classList.remove("show");
        setTimeout(() => modalPostulacionOverlay.style.display = "none", 250);
      }

      cerrarPostulacion.onclick = cerrarModalPostulacion;
      btnCancelarPostulacion.onclick = cerrarModalPostulacion;

      // === üîπ Enviar postulaci√≥n (contraoferta) ===
      btnEnviarPostulacion.addEventListener("click", () => {
        if (!solicitudActual || solicitudActual.estado !== "Pendiente") {
          showToast("La solicitud ya no est√° disponible.", "info");
          cerrarModalPostulacion();
          return;
        }

        const monto = parseFloat(ofertaMonto.value);
        const mensaje = ofertaMensaje.value.trim();
        const ofertaFinal = !isNaN(monto) && monto > 0 ? monto : parseFloat(solicitudActual.pago || 0);

        // refrescar DB
        db = JSON.parse(localStorage.getItem("solicitudesAgroLink") || "[]");
        const idxS = db.findIndex(s => s.id === solicitudActual.id);
        if (idxS === -1) {
          showToast("La solicitud ya no existe.", "error");
          cerrarModalPostulacion();
          renderList();
          return;
        }
        const s = db[idxS];
        if (!Array.isArray(s.postulaciones)) s.postulaciones = [];

        const postId = usuario.id || usuario.email || usuario.correo || usuario.nombre;

        const existente = s.postulaciones.find(p => p.id === postId);
        if (existente) {
          existente.oferta = ofertaFinal.toFixed(2);
          existente.mensaje = mensaje;
          existente.fecha = new Date().toISOString();
        } else {
          s.postulaciones.push({
            id: postId,
            nombre: usuario.nombre || "Transportista",
            oferta: ofertaFinal.toFixed(2),
            mensaje,
            fecha: new Date().toISOString(),
            estado: "pendiente"
          });
        }

        db[idxS] = s;
        localStorage.setItem("solicitudesAgroLink", JSON.stringify(db));

        showToast("‚úÖ Postulaci√≥n enviada al productor.", "success");
        cerrarModalPostulacion();
        renderList();
      });

      // === Denunciar (igual que antes) ===
      btnDenunciar.addEventListener("click", () => {
        if (!solicitudActual || solicitudActual.estado !== "Pendiente") {
          showToast("La solicitud ya no est√° disponible.", "info");
          renderList();
          return;
        }
        const motivo = prompt("Indica el motivo de la denuncia (opcional):");
        if (motivo === null && !confirm("¬øDeseas denunciar sin motivo?")) return;

        solicitudActual.estado = "Denunciada";
        guardarDB();

        const denuncias = JSON.parse(localStorage.getItem("denunciasAgroLink") || "[]");
        denuncias.push({
          id: `den_${Date.now()}`,
          solicitudId: solicitudActual.id || solicitudActual.fecha,
          productor: solicitudActual.productor || null,
          tipo: solicitudActual.tipo || null,
          motivo: motivo || "",
          denunciadoPor: usuario.nombre || null,
          fecha: new Date().toISOString()
        });
        localStorage.setItem("denunciasAgroLink", JSON.stringify(denuncias));

        showToast("üö© Solicitud denunciada y removida de la lista.", "error");
        panel.classList.remove("show");
        overlay.style.display = "none";
        document.body.style.overflow = "auto";
        setTimeout(() => {
          db = JSON.parse(localStorage.getItem("solicitudesAgroLink") || "[]");
          poblarTipos(); renderList();
        }, 500);
      });

      btnAplicar.addEventListener("click", e => { e.preventDefault(); renderList(); });
      btnReset.addEventListener("click", e => {
        e.preventDefault();
        [filterTipo, filterOrigen, filterDestino, filterMinPago, filterMaxPago].forEach(f => f.value = "");
        renderList();
      });

      // === Logout persistente (igual) ===
      document.getElementById("logout").addEventListener("click", e => {
        e.preventDefault();
        const usuarios = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
        const idx = usuarios.findIndex(u => (u.email || u.correo) === (usuario.email || usuario.correo));
        if (idx !== -1) {
          usuarios[idx].sesionActiva = false;
          localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuarios));
        }
        localStorage.removeItem("agrolinkUsuario");
        localStorage.removeItem("agrolinkRol");
        showToast("üëã Sesi√≥n cerrada correctamente", "info");
        setTimeout(() => window.location.href = "../index.html", 800);
      });

      poblarTipos();
      renderList();
    });
  </script>
</body>

</html>