<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro | AgroLink</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="img/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body class="auth-body">

  <!-- ====== ENCABEZADO ====== -->
  <header class="auth-header">
    <a href="index.html" class="logo-auth">
      <i class="fa-solid fa-tractor"></i>
      <span>AgroLink</span>
    </a>
  </header>


  <!-- ====== CONTENIDO PRINCIPAL ====== -->
  <main class="auth-container">
    <div class="auth-card">
      <h2>Crea tu cuenta</h2>
      <p>Conecta con transportistas y productores rurales f√°cilmente.</p>

      <form id="registroForm" class="auth-form">
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" name="nombre" required>

        <label for="email">Correo electr√≥nico</label>
        <input type="email" id="email" name="email" required>

        <label for="password">Contrase√±a</label>
        <input type="password" id="password" name="password" required>

        <label for="rol">Rol</label>
        <select id="rol" name="rol" required>
          <option value="">Seleccione un rol</option>
          <option value="productor">Productor</option>
          <option value="transportista">Transportista</option>
        </select>

        <!-- üîΩ Secci√≥n solo para transportistas -->
        <div id="camposTransportista" class="hidden">
          <label for="fotoPerfil">Foto de perfil</label>
          <input type="file" id="fotoPerfil" accept="image/*">

          <label for="vehiculoImg">Imagen del veh√≠culo</label>
          <input type="file" id="vehiculoImg" accept="image/*">

          <label for="placa">Placa del veh√≠culo</label>
          <input type="text" id="placa" name="placa" placeholder="ABC-123">

          <label for="capacidad">Capacidad de carga (kg)</label>
          <input type="number" id="capacidad" name="capacidad" min="0" step="100">

          <label for="licencia">N√∫mero de licencia de conducir</label>
          <input type="text" id="licencia" name="licencia">

          <label for="cuentaBancaria">Cuenta bancaria (para pagos)</label>
          <input type="text" id="cuentaBancaria" name="cuentaBancaria">

          <label for="soat">SOAT del veh√≠culo</label>
          <input type="file" id="soat" accept=".pdf,.jpg,.png">

          <label for="revision">Certificado de revisi√≥n t√©cnica</label>
          <input type="file" id="revision" accept=".pdf,.jpg,.png">
        </div>

        <button type="submit" class="btn btn-primary">Registrarse</button>
        <p class="switch-text">¬øYa tienes una cuenta?
          <a href="login.html">Inicia sesi√≥n aqu√≠</a>
        </p>
      </form>

      <div id="mensajeExito" class="mensaje-exito" style="display:none; background-color:#e9ffe9; color:#1b5e20;">
        ‚úÖ Registro exitoso. Redirigiendo a tu panel...
      </div>
    </div>
  </main>

  <!-- ====== FOOTER ====== -->
  <footer class="footer">
    <p>¬© 2025 AgroLink. Todos los derechos reservados.</p>
  </footer>

  <!-- ====== SCRIPT ====== -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("registroForm");
    const mensajeExito = document.getElementById("mensajeExito");
    const rolSelect = document.getElementById("rol");
    const camposTransportista = document.getElementById("camposTransportista");

    // Mostrar/ocultar campos del transportista
    rolSelect.addEventListener("change", () => {
      const esTransportista = rolSelect.value === "transportista";
      camposTransportista.classList.toggle("hidden", !esTransportista);

      if (!esTransportista) {
        camposTransportista.querySelectorAll("input").forEach(i => (i.value = ""));
      }
    });

    // Funci√≥n para convertir imagen a Base64
    const fileToBase64 = (file) => new Promise((resolve, reject) => {
      if (!file) return resolve("");
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });

    // ====== REGISTRO ======
    form.addEventListener("submit", async e => {
      e.preventDefault();

      const rol = rolSelect.value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      const email = document.getElementById("email").value.trim().toLowerCase();
      const password = document.getElementById("password").value.trim();

      if (!rol || !nombre || !email || !password) {
        alert("‚ö†Ô∏è Por favor, completa todos los campos obligatorios.");
        return;
      }

      // Obtener usuarios existentes
      const usuarios = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];

      if (usuarios.some(u => u.email === email)) {
        alert("‚ö†Ô∏è Este correo ya est√° registrado. Inicia sesi√≥n.");
        window.location.href = "login.html";
        return;
      }

      // Crear objeto base
      const nuevoUsuario = {
        rol,
        nombre,
        email,
        password,
        fechaRegistro: new Date().toLocaleString("es-PE"),
      };

      // Si es transportista, a√±adir datos adicionales
      if (rol === "transportista") {
        nuevoUsuario.placa = document.getElementById("placa").value.trim();
        nuevoUsuario.capacidad = document.getElementById("capacidad").value.trim();
        nuevoUsuario.licencia = document.getElementById("licencia").value.trim();
        nuevoUsuario.cuentaBancaria = document.getElementById("cuentaBancaria").value.trim();
        nuevoUsuario.fotoPerfil = await fileToBase64(document.getElementById("fotoPerfil").files[0]);
        nuevoUsuario.vehiculoImg = await fileToBase64(document.getElementById("vehiculoImg").files[0]);

        // Documentos
        const soatFile = document.getElementById("soat").files[0];
        const revisionFile = document.getElementById("revision").files[0];

        if (soatFile) {
          nuevoUsuario.soatData = await fileToBase64(soatFile);
          nuevoUsuario.soatNombre = soatFile.name;
        }

        if (revisionFile) {
          nuevoUsuario.revisionData = await fileToBase64(revisionFile);
          nuevoUsuario.revisionNombre = revisionFile.name;
        }
      }

      // Guardar en lista global
      usuarios.push(nuevoUsuario);
      localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuarios));

      // Guardar sesi√≥n activa
      localStorage.setItem("usuarioActivo", JSON.stringify(nuevoUsuario));

      // Mostrar mensaje de √©xito
      mensajeExito.style.display = "block";
      setTimeout(() => {
        mensajeExito.style.display = "none";
        window.location.href =
          rol === "productor"
            ? "productor/dashboard.html"
            : "transportista/dashboard.html";
      }, 1800);
    });
  });
</script>

</body>

</html>