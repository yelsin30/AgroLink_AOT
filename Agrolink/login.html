<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar SesiÃ³n | AgroLink</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="img/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body class="auth-body">
  <header class="auth-header">
    <a href="index.html" class="logo-auth">
      <i class="fa-solid fa-tractor"></i>
      <span>AgroLink</span>
    </a>
  </header>

  <main class="auth-container">
    <div class="auth-card">
      <h2>Bienvenido a AgroLink</h2>
      <p>Inicia sesiÃ³n para continuar gestionando tus envÃ­os agrÃ­colas.</p>

      <form id="loginForm" class="auth-form">
        <label for="email">Correo electrÃ³nico</label>
        <input type="email" id="email" placeholder="usuario@correo.com" required>

        <label for="password">ContraseÃ±a</label>
        <input type="password" id="password" placeholder="********" required>

        <button type="submit" class="btn btn-primary">Iniciar SesiÃ³n</button>

        <p class="switch-text">Â¿No tienes una cuenta?
          <a href="registro.html">RegÃ­strate aquÃ­</a>
        </p>
      </form>

      <div id="mensajeError" class="mensaje-exito" style="display:none; background-color:#ffeaea; color:#a00000;">
        âš ï¸ Credenciales incorrectas. Intenta nuevamente.
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>Â© 2025 AgroLink. Todos los derechos reservados.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("loginForm");
      const mensajeError = document.getElementById("mensajeError");

      // ===============================
      // ğŸ‘‘ Crear cuenta admin por defecto
      // ===============================
      const usuariosLS = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];
      const existeAdmin = usuariosLS.some(u => (u.email || "").toLowerCase() === "admin@agrolink.com");

      if (!existeAdmin) {
        usuariosLS.push({
          id: "USR-000",
          nombre: "Administrador General",
          email: "admin@agrolink.com",
          password: "admin123",
          rol: "admin",
          ultimoAcceso: new Date().toLocaleString("es-PE")
        });
        localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuariosLS));
      }

      // ===============================
      // ğŸ” INICIO DE SESIÃ“N
      // ===============================
      form.addEventListener("submit", e => {
        e.preventDefault();

        const email = document.getElementById("email").value.trim().toLowerCase();
        const password = document.getElementById("password").value.trim();

        const usuariosActuales = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];

        // Buscar usuario (admite "password" o "contrasena")
        const usuario = usuariosActuales.find(u => {
          const correo = (u.email || u.correo || "").toLowerCase();
          const clave = u.password || u.contrasena;
          return correo === email && clave === password;
        });

        if (!usuario) {
          mensajeError.textContent = "âš ï¸ Credenciales incorrectas. Intenta nuevamente.";
          mensajeError.style.display = "block";
          setTimeout(() => mensajeError.style.display = "none", 2500);
          return;
        }

        // ===============================
        // ğŸ§  Rol de compatibilidad
        // ===============================
        if (!usuario.rol) {
          if ((usuario.email || "").toLowerCase() === "admin@agrolink.com") usuario.rol = "admin";
          else if (usuario.capacidad || usuario.placa) usuario.rol = "transportista";
          else usuario.rol = "productor";
        }

        // ===============================
        // ğŸ“… Actualizar Ãºltimo acceso
        // ===============================
        usuario.ultimoAcceso = new Date().toLocaleString("es-PE");
        const idx = usuariosActuales.findIndex(u => (u.email || "").toLowerCase() === email);
        if (idx !== -1) {
          usuariosActuales[idx] = usuario;
          localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuariosActuales));
        }

        // ===============================
        // ğŸ’¾ Guardar sesiÃ³n activa
        // ===============================
        localStorage.setItem("usuarioActivo", JSON.stringify(usuario));
        localStorage.setItem("agrolinkUsuario", JSON.stringify(usuario));
        localStorage.setItem("agrolinkRol", usuario.rol);

        // ===============================
        // ğŸ§­ RedirecciÃ³n segÃºn rol
        // ===============================
        const rol = usuario.rol.toLowerCase();

        if (rol === "admin") {
          alert("ğŸ‘¨â€ğŸ’¼ Bienvenido Administrador");
          window.location.href = "admin/admin.html";
        } else if (rol === "productor") {
          alert("ğŸ‘¨â€ğŸŒ¾ Bienvenido Productor");
          window.location.href = "productor/dashboard.html";
        } else if (rol === "transportista" || rol === "conductor") {
          alert("ğŸšš Bienvenido Transportista");
          window.location.href = "transportista/dashboard.html";
        } else {
          alert("âš ï¸ Rol desconocido. Se redirigirÃ¡ al inicio.");
          window.location.href = "index.html";
        }
      });
    });
  </script>
</body>

</html>
