<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar Sesi√≥n | AgroLink</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="img/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body class="auth-body">
  <header class="auth-header">
    <a href="index.html" class="logo-auth">
      <i class="fa-solid fa-tractor"></i>
      <span>AgroLink</span>
    </a>
  </header>

  <main class="auth-container">
    <div class="auth-card">
      <h2>Bienvenido a AgroLink</h2>
      <p>Inicia sesi√≥n para continuar gestionando tus env√≠os agr√≠colas.</p>

      <form id="loginForm" class="auth-form">
        <label for="email">Correo electr√≥nico</label>
        <input type="email" id="email" placeholder="usuario@correo.com" required>

        <label for="password">Contrase√±a</label>
        <input type="password" id="password" placeholder="********" required>

        <button type="submit" class="btn btn-primary">Iniciar Sesi√≥n</button>

        <p class="switch-text">¬øNo tienes una cuenta?
          <a href="registro.html">Reg√≠strate aqu√≠</a>
        </p>
      </form>

      <div id="mensajeError" class="mensaje-exito" style="display:none; background-color:#ffeaea; color:#a00000;">
        ‚ö†Ô∏è Credenciales incorrectas. Intenta nuevamente.
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>¬© 2025 AgroLink. Todos los derechos reservados.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("loginForm");
      const mensajeError = document.getElementById("mensajeError");

      // ===============================
      // üëë Crear cuenta admin por defecto
      // ===============================
      const usuariosLS = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];
      const existeAdmin = usuariosLS.some(u => (u.email || "").toLowerCase() === "admin@agrolink.com");

      if (!existeAdmin) {
        usuariosLS.push({
          id: "USR-000",
          nombre: "Administrador General",
          email: "admin@agrolink.com",
          password: "admin123",
          rol: "admin",
          ultimoAcceso: new Date().toLocaleString("es-PE")
        });
        localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuariosLS));
      }

      // ===============================
      // üîê INICIO DE SESI√ìN
      // ===============================
      form.addEventListener("submit", e => {
        e.preventDefault();

        const email = document.getElementById("email").value.trim().toLowerCase();
        const password = document.getElementById("password").value.trim();
        const usuariosActuales = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];

        const usuario = usuariosActuales.find(u => {
          const correo = (u.email || u.correo || "").toLowerCase();
          const clave = u.password || u.contrasena;
          return correo === email && clave === password;
        });

        if (!usuario) {
          mensajeError.textContent = "‚ö†Ô∏è Credenciales incorrectas. Intenta nuevamente.";
          mensajeError.style.display = "block";
          setTimeout(() => mensajeError.style.display = "none", 2500);
          return;
        }

        // ===============================
        // üß† Rol de compatibilidad
        // ===============================
        if (!usuario.rol) {
          if ((usuario.email || "").toLowerCase() === "admin@agrolink.com") usuario.rol = "admin";
          else if (usuario.capacidad || usuario.placa) usuario.rol = "transportista";
          else usuario.rol = "productor";
        }

        // ===============================
        // üìÖ Actualizar √∫ltimo acceso
        // ===============================
        usuario.ultimoAcceso = new Date().toLocaleString("es-PE");
        const idx = usuariosActuales.findIndex(u => (u.email || "").toLowerCase() === email);
        if (idx !== -1) {
          usuariosActuales[idx] = usuario;
          localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuariosActuales));
        }

        // ===============================
        // üßπ Guardar solo datos esenciales
        // ===============================
        const usuarioLimpio = {
          id: usuario.id || Date.now(),
          nombre: usuario.nombre,
          correo: usuario.correo || usuario.email,
          rol: usuario.rol,
          avatar: usuario.avatar && usuario.avatar.length < 8000 ? usuario.avatar : null // evita base64 pesadas
        };

        // Intentar guardar sin sobrecargar el localStorage
        try {
          localStorage.removeItem("agrolinkUsuario");
          localStorage.removeItem("usuarioActivo");
          localStorage.setItem("agrolinkUsuario", JSON.stringify(usuarioLimpio));
          localStorage.setItem("usuarioActivo", JSON.stringify(usuarioLimpio));
          localStorage.setItem("agrolinkRol", usuario.rol);
        } catch (e) {
          if (e.name === "QuotaExceededError") {
            console.warn("‚ö†Ô∏è Almacenamiento lleno. Limpiando...");
            localStorage.clear();
            localStorage.setItem("agrolinkUsuario", JSON.stringify(usuarioLimpio));
            localStorage.setItem("usuarioActivo", JSON.stringify(usuarioLimpio));
            localStorage.setItem("agrolinkRol", usuario.rol);
          }
        }

        // ===============================
        // üß≠ Redirecci√≥n seg√∫n rol
        // ===============================
        const rol = usuario.rol.toLowerCase();

        if (rol === "admin") {
          alert("üë®‚Äçüíº Bienvenido Administrador");
          window.location.href = "admin/admin.html";
        } else if (rol === "productor") {
          alert("üë®‚Äçüåæ Bienvenido Productor");
          window.location.href = "productor/dashboard.html";
        } else if (rol === "transportista" || rol === "conductor") {
          alert("üöö Bienvenido Transportista");
          window.location.href = "transportista/dashboard.html";
        } else {
          alert("‚ö†Ô∏è Rol desconocido. Se redirigir√° al inicio.");
          window.location.href = "index.html";
        }
      });
    });
  </script>
</body>
</html>
