<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat | AgroLink</title>

    <!-- Iconos y librerÃ­as -->
    <link rel="icon" href="../img/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Estilos del chat -->
    <link rel="stylesheet" href="../../css/Productor/chat.css">

</head>

<body>

    <!-- ===== ENCABEZADO ===== -->
    <header>
        <div class="chat-title">
            <i class="fa-solid fa-user-truck fa-lg"></i>
            <h5 id="chatNombre">Transportista</h5>
        </div>
        <button class="btn-volver" onclick="history.back()">
            <i class="fa-solid fa-arrow-left"></i> Volver
        </button>
    </header>

    <!-- ===== CUERPO DEL CHAT ===== -->
    <div id="chatBody" class="chat-body">
        <!-- Los mensajes se insertan dinÃ¡micamente -->
    </div>

    <!-- ===== PIE DE MENSAJE ===== -->
    <footer class="chat-footer">
        <button class="btn-archivo" id="btnArchivo"><i class="fa-solid fa-paperclip"></i></button>
        <input type="file" id="inputArchivo" accept="image/*" hidden>
        <input type="text" id="mensajeInput" placeholder="Escribe un mensaje...">
        <button id="btnEnviar"><i class="fa-solid fa-paper-plane"></i></button>
    </footer>

    <!-- ===== SCRIPT DEL CHAT ===== -->
    <script>
        const chatBody = document.getElementById("chatBody");
        const mensajeInput = document.getElementById("mensajeInput");
        const btnEnviar = document.getElementById("btnEnviar");
        const btnArchivo = document.getElementById("btnArchivo");
        const inputArchivo = document.getElementById("inputArchivo");

        // Clave Ãºnica para guardar mensajes
        const chatKey = "chatAgroLink";
        const mensajes = JSON.parse(localStorage.getItem(chatKey) || "[]");

        // Mostrar mensajes
        function renderMensajes() {
            chatBody.innerHTML = "";
            mensajes.forEach(m => {
                const div = document.createElement("div");
                div.className = `mensaje ${m.tipo === "enviado" ? "msg-enviado" : "msg-recibido"}`;
                div.innerHTML = m.texto;
                if (m.imagen) {
                    const img = document.createElement("img");
                    img.src = m.imagen;
                    div.appendChild(img);
                }
                chatBody.appendChild(div);
            });
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        renderMensajes();

        btnEnviar.addEventListener("click", () => {
            const texto = mensajeInput.value.trim();
            if (!texto) return;
            mensajes.push({ tipo: "enviado", texto });
            localStorage.setItem(chatKey, JSON.stringify(mensajes));
            mensajeInput.value = "";
            renderMensajes();
        });

        mensajeInput.addEventListener("keypress", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                btnEnviar.click();
            }
        });

        btnArchivo.addEventListener("click", () => inputArchivo.click());

        inputArchivo.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                mensajes.push({ tipo: "enviado", texto: "ðŸ“Ž Imagen adjunta", imagen: reader.result });
                localStorage.setItem(chatKey, JSON.stringify(mensajes));
                renderMensajes();
            };
            reader.readAsDataURL(file);
        });

        // Mensaje automÃ¡tico de demostraciÃ³n
        setTimeout(() => {
            mensajes.push({ tipo: "recibido", texto: "Â¡Hola! Estoy en camino ðŸšš" });
            localStorage.setItem(chatKey, JSON.stringify(mensajes));
            renderMensajes();
        }, 1000);
    </script>

</body>

</html>