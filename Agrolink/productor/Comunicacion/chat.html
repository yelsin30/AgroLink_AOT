<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Productor | AgroLink</title>

  <link rel="icon" href="../../img/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/Productor/chat.css" />
</head>

<body>
  <div class="chat-page">
    <header class="chat-header">
      <button class="btn-volver" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Volver</button>
      <div class="chat-info">
        <i class="fa-solid fa-truck"></i>
        <div>
          <h5 id="nombreTransportista">Transportista</h5>
          <small>Conectado...</small>
        </div>
      </div>
    </header>

    <main class="chat-body" id="chatBody"></main>

    <footer class="chat-footer">
      <div class="input-wrap">
        <button class="icon-btn"><i class="fa-solid fa-paperclip"></i></button>
        <input id="mensajeInput" type="text" placeholder="Escribe un mensaje..." />
        <button id="enviarBtn" class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </footer>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  /* ======================================================
      VALIDACIN DE SESIN PERSISTENTE (Opci贸n 2)
  ====================================================== */
  let usuario = JSON.parse(localStorage.getItem("agrolinkUsuario"));
  const usuarios = JSON.parse(localStorage.getItem("agrolinkUsuarios")) || [];

  // Si no hay sesi贸n activa, redirige al inicio
  if (!usuario || !(usuario.email || usuario.correo)) {
    alert("锔 No has iniciado sesi贸n. Vuelve a ingresar.");
    window.location.href = "../../index.html";
    return;
  }

  // Sincronizar con la versi贸n m谩s reciente guardada
  const clave = usuario.email || usuario.correo;
  const actualizado = usuarios.find(u => (u.email || u.correo) === clave);
  if (actualizado) {
    usuario = { ...usuario, ...actualizado };
    localStorage.setItem("agrolinkUsuario", JSON.stringify(usuario));
  }

  /* ======================================================
      CHAT PRODUCTOR ORIGINAL
  ====================================================== */
  const params = new URLSearchParams(window.location.search);
  const envioID = params.get("id");
  const transportista = params.get("transportista") || "Transportista";
  const chatKey = `chat_${envioID}`;
  const chatBody = document.getElementById("chatBody");

  const nombreProductor = usuario.nombre || "Productor";
  const fotoProductor = usuario.avatar || usuario.foto || null;

  document.getElementById("nombreTransportista").textContent = transportista;

  let mensajes = JSON.parse(localStorage.getItem(chatKey)) || [];

  function renderMensajes() {
    chatBody.innerHTML = "";
    mensajes.forEach(msg => {
      const isMine = msg.rol === "productor";
      const contenedor = document.createElement("div");
      contenedor.classList.add("mensaje-contenedor", isMine ? "enviado" : "recibido");

      const avatar = document.createElement("div");
      avatar.classList.add("avatar");
      avatar.textContent = msg.remitente.charAt(0).toUpperCase();

      const burbuja = document.createElement("div");
      burbuja.classList.add("mensaje", isMine ? "msg-enviado" : "msg-recibido");
      const hora = new Date(msg.fecha).toLocaleTimeString("es-PE", { hour: "2-digit", minute: "2-digit" });
      burbuja.innerHTML = `<p>${msg.texto}</p><small>${hora}</small>`;

      if (isMine) {
        contenedor.appendChild(burbuja);
        contenedor.appendChild(avatar);
      } else {
        contenedor.appendChild(avatar);
        contenedor.appendChild(burbuja);
      }

      chatBody.appendChild(contenedor);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function enviarMensaje() {
    const input = document.getElementById("mensajeInput");
    const texto = input.value.trim();
    if (!texto) return;

    const nuevoMsg = {
      remitente: nombreProductor,
      rol: "productor",
      texto,
      fecha: new Date().toISOString(),
      foto: fotoProductor
    };

    mensajes.push(nuevoMsg);
    localStorage.setItem(chatKey, JSON.stringify(mensajes));
    input.value = "";
    renderMensajes();
  }

  document.getElementById("enviarBtn").addEventListener("click", enviarMensaje);
  document.getElementById("mensajeInput").addEventListener("keypress", e => {
    if (e.key === "Enter") enviarMensaje();
  });

  // Actualizaci贸n en tiempo real cuando el transportista env铆a mensajes
  window.addEventListener("storage", e => {
    if (e.key === chatKey) {
      mensajes = JSON.parse(e.newValue || "[]");
      renderMensajes();
    }
  });

  renderMensajes();
});
</script>

</body>

</html>
