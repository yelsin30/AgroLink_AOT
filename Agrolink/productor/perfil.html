<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Perfil | AgroLink</title>

  <!-- Bootstrap primero -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- ‚úÖ Tu CSS siempre al final -->
  <link rel="stylesheet" href="../css/Productor/perfil.css" />
</head>


<body>
  <!-- Sidebar AgroLink -->
  <aside class="agro-sidebar">
    <i class="fa-solid fa-tractor logo"></i>

    <div class="agro-menu">
      <button title="Inicio" onclick="location.href='dashboard.html'"><i class="fa-solid fa-house"></i></button>
      <button title="Env√≠os" onclick="location.href='envios.html'"><i class="fa-solid fa-truck"></i></button>
      <button title="Solicitudes" onclick="location.href='solicitudes.html'">
        <i class="fa-solid fa-file-circle-plus"></i>
      </button>
      <button class="active" title="Perfil" onclick="location.href='perfil.html'">
        <i class="fa-solid fa-user"></i>
      </button>
    </div>

    <button class="agro-logout" id="logout">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Salir</span>
    </button>
  </aside>

  <!-- Contenido principal -->
  <main>
    <div class="profile-container">
      <div class="profile-header">
        <img id="avatarPreview" src="../img/user-placeholder.png" alt="Foto de perfil" />
        <h2 id="nombreDisplay">Productor</h2>
        <p id="regionDisplay">Regi√≥n no establecida</p>
        <button id="btnCambiarFoto"><i class="fa-solid fa-camera"></i> Cambiar foto</button>

        <div class="mt-3 d-flex justify-content-center flex-wrap">
          <div class="summary-box"><i class="fa-solid fa-truck"></i> <span id="enviosCompletados">0 Env√≠os</span></div>
          <div class="summary-box"><i class="fa-solid fa-star"></i> <span id="promedioCalif">0.0 ‚òÖ</span></div>
        </div>
      </div>

      <form id="perfilForm">
        <div class="card p-4">
          <h4 class="mb-3"><i class="fa-solid fa-user"></i> Informaci√≥n personal</h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label>Nombre completo</label>
              <input id="nombre" required />
            </div>
            <div class="col-md-6">
              <label>Correo electr√≥nico</label>
              <input id="correo" type="email" placeholder="Ej: usuario@correo.com" required />
            </div>
            <div class="col-md-6">
              <label>Tel√©fono</label>
              <input id="telefono" type="tel" placeholder="Ej: +51 987654321" />
            </div>
            <div class="col-md-6">
              <label>Ubicaci√≥n principal</label>
              <select id="region">
                <option value="">Seleccionar regi√≥n...</option>
                <option>Lima</option>
                <option>Trujillo</option>
                <option>Arequipa</option>
                <option>Piura</option>
                <option>Chiclayo</option>
                <option>Cusco</option>
                <option>Puno</option>
                <option>Huancayo</option>
              </select>
            </div>
            <div class="col-md-6">
              <label>Tipo de productos</label>
              <input id="productos" placeholder="Ej: papa, ma√≠z, palta..." />
            </div>
            <div class="col-12">
              <label>Descripci√≥n breve</label>
              <textarea id="descripcion" placeholder="Cu√©ntanos brevemente sobre tu producci√≥n o finca..."></textarea>
            </div>
          </div>
        </div>

        <div class="card p-4">
          <h4 class="mb-3"><i class="fa-solid fa-lock"></i> Contrase√±a</h4>
          <label>Nueva contrase√±a</label>
          <input id="password" type="password" placeholder="********" autocomplete="new-password" />
        </div>

        <button class="btn-save mt-3" type="submit"><i class="fa-solid fa-save"></i> Guardar Cambios</button>
      </form>

      <footer>¬© 2025 AgroLink. Todos los derechos reservados.</footer>
    </div>
  </main>

  <!-- JS -->
  <script src="../js/toast.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let usuario = JSON.parse(localStorage.getItem("agrolinkUsuario") || "null");
      const usuariosTodos = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");

      if (!usuario || !(usuario.email || usuario.correo)) {
        alert("‚ö†Ô∏è No has iniciado sesi√≥n. Vuelve a ingresar.");
        window.location.href = "../index.html";
        return;
      }

      const clave = usuario.email || usuario.correo;
      const actualizado = usuariosTodos.find(u => (u.email || u.correo) === clave);
      if (actualizado) {
        usuario = { ...usuario, ...actualizado };
        localStorage.setItem("agrolinkUsuario", JSON.stringify(usuario));
      }

      const solicitudes = JSON.parse(localStorage.getItem("solicitudesAgroLink") || "[]");
      const enviosProductor = solicitudes.filter(
        s => (s.productor || "").toLowerCase() === (usuario.nombre || "").toLowerCase()
      );
      const completados = enviosProductor.filter(e => /Completado/.test(e.estado));
      const promedio = completados.length
        ? (completados.reduce((a, e) => a + (parseFloat(e.calificacion) || 0), 0) / completados.length).toFixed(1)
        : "0.0";

      document.getElementById("enviosCompletados").textContent = `${completados.length} Env√≠os`;
      document.getElementById("promedioCalif").textContent = `${promedio} ‚òÖ`;

      document.getElementById("nombre").value = usuario.nombre || "";
      document.getElementById("correo").value = usuario.email || usuario.correo || "";
      document.getElementById("telefono").value = usuario.telefono || "";
      document.getElementById("region").value = usuario.region || "";
      document.getElementById("productos").value = usuario.productos || "";
      document.getElementById("descripcion").value = usuario.descripcion || "";
      document.getElementById("nombreDisplay").textContent = usuario.nombre || "Productor";
      document.getElementById("regionDisplay").textContent = usuario.region || "Regi√≥n no establecida";
      if (usuario.avatar) document.getElementById("avatarPreview").src = usuario.avatar;

      document.getElementById("btnCambiarFoto").addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = ev => {
              usuario.avatar = ev.target.result;
              document.getElementById("avatarPreview").src = ev.target.result;
              guardarUsuario(usuario);
              showToast("üì∑ Foto actualizada correctamente", "success");
            };
            reader.readAsDataURL(file);
          }
        };
        input.click();
      });

      document.getElementById("perfilForm").addEventListener("submit", e => {
        e.preventDefault();
        usuario.nombre = document.getElementById("nombre").value.trim();
        usuario.email = document.getElementById("correo").value.trim();
        usuario.telefono = document.getElementById("telefono").value.trim();
        usuario.region = document.getElementById("region").value;
        usuario.productos = document.getElementById("productos").value.trim();
        usuario.descripcion = document.getElementById("descripcion").value.trim();
        const pass = document.getElementById("password").value.trim();
        if (pass) usuario.password = pass;
        guardarUsuario(usuario);
        document.getElementById("nombreDisplay").textContent = usuario.nombre;
        document.getElementById("regionDisplay").textContent = usuario.region || "Regi√≥n no establecida";
        showToast("‚úÖ Perfil actualizado correctamente", "success");
      });

      function guardarUsuario(usuarioActualizado) {
        localStorage.setItem("agrolinkUsuario", JSON.stringify(usuarioActualizado));
        const usuarios = JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
        const index = usuarios.findIndex(u => u.email === usuarioActualizado.email);
        if (index !== -1) {
          usuarios[index] = usuarioActualizado;
        } else {
          usuarios.push(usuarioActualizado);
        }
        localStorage.setItem("agrolinkUsuarios", JSON.stringify(usuarios));
      }

      document.getElementById("logout").addEventListener("click", e => {
        e.preventDefault();
        localStorage.removeItem("agrolinkUsuario");
        localStorage.removeItem("agrolinkRol");
        window.location.href = "../index.html";
      });
    });
  </script>
</body>
</html>
