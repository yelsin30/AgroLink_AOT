<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgroLink - Gesti√≥n de Usuarios</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/Admin/usuarios.css" />
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-truck"></i>
      <h1>AgroLink</h1>
    </div>
    <nav class="nav-menu">
      <a href="admin.html" class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
      <a href="envios.html" class="nav-item"><i class="fas fa-truck"></i><span>Env√≠os</span></a>
      <a href="transportistas.html" class="nav-item"><i class="fas fa-users"></i><span>Transportistas</span></a>
      <a href="productos.html" class="nav-item"><i class="fas fa-box"></i><span>Productos</span></a>
      <a href="usuarios.html" class="nav-item active"><i class="fas fa-user"></i><span>Usuarios</span></a>
      <a href="reportes.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
      <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuraci√≥n</span></a>
      <a href="../index.html" class="nav-item logout" id="btnLogout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi√≥n</span></a>
    </nav>
  </aside>

  <!-- Contenido principal -->
  <main class="main-content">
    <header class="header">
      <div class="header-title">
        <i class="fas fa-user"></i>
        <h1>Gesti√≥n de Usuarios (Productores)</h1>
      </div>
      <div class="user-profile">
        <div class="avatar" id="adminAvatar">A</div>
        <span class="username" id="adminName">Admin</span>
      </div>
    </header>

    <div class="search-filters">
      <h2>Filtros de b√∫squeda</h2>
      <div class="filters-container">
        <div class="filter-input">
          <input type="text" placeholder="Nombre (Ej. Juan)" id="filterNombre" />
        </div>
        <!-- El rol siempre ser√° 'productor', pero dejo el filtro sencillo -->
        <div class="filter-input">
          <select id="filterRol">
            <option value="">Todos los roles</option>
            <option value="productor">Productor</option>
          </select>
        </div>
        <button class="filter-button" id="btnBuscar">
          <i class="fas fa-search"></i> Buscar
        </button>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-add" id="btnAgregar"><i class="fas fa-plus"></i> Agregar Usuario</button>
      <button class="btn btn-delete" id="btnEliminar"><i class="fas fa-trash"></i> Eliminar todos</button>
    </div>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Rol</th>
            <th>√öltimo Acceso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="usuariosTableBody"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Agregar -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Agregar Nuevo Usuario (Productor)</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="addForm">
        <div class="form-group">
          <label>Nombre Completo</label>
          <input type="text" id="addNombre" placeholder="Ej. Juan P√©rez" required />
        </div>
        <div class="form-group">
          <label>Correo Electr√≥nico</label>
          <input type="email" id="addCorreo" placeholder="Ej. juan@agrolink.com" required />
        </div>
        <div class="form-group">
          <label>Rol</label>
          <!-- Siempre productor en este panel -->
          <select id="addRol" required>
            <option value="productor">Productor</option>
          </select>
        </div>
        <div class="form-group">
          <label>√öltimo Acceso</label>
          <input type="text" id="addUltimoAcceso" placeholder="Ej. 22/10/2025" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" id="cancelAdd">Cancelar</button>
          <button type="submit" class="btn btn-add">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Usuario (Productor)</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editId" />
        <div class="form-group">
          <label>Nombre Completo</label>
          <input type="text" id="editNombre" required />
        </div>
        <div class="form-group">
          <label>Correo Electr√≥nico</label>
          <input type="email" id="editCorreo" required />
        </div>
        <div class="form-group">
          <label>Rol</label>
          <select id="editRol" required>
            <option value="productor">Productor</option>
          </select>
        </div>
        <div class="form-group">
          <label>√öltimo Acceso</label>
          <input type="text" id="editUltimoAcceso" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" id="cancelEdit">Cancelar</button>
          <button type="submit" class="btn btn-add">Actualizar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========= UTILIDADES DE USUARIOS (BASE REAL: agrolinkUsuarios) =========

    const STORAGE_KEY = "agrolinkUsuarios";

    // Leer todos los usuarios reales
    function getUsuariosBase() {
      const lista = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      let changed = false;

      // Asegurar que todos tengan un ID
      lista.forEach(u => {
        if (!u.id) {
          u.id = "USR-" + Date.now().toString().slice(-6) + "-" + Math.floor(Math.random() * 1000);
          changed = true;
        }
      });

      if (changed) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
      }
      return lista;
    }

    // Solo productores
    function getUsuariosProductores() {
      return getUsuariosBase().filter(
        u => (u.rol || "").toLowerCase() === "productor"
      );
    }

    // Guardar lista de productores, respetando otros roles (admin, transportista, etc.)
    function saveUsuariosProductores(nuevaListaProductores) {
      const base = getUsuariosBase();
      const otros = base.filter(
        u => (u.rol || "").toLowerCase() !== "productor"
      );
      const merged = [...otros, ...nuevaListaProductores];
      localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
    }

    // ========= RENDER TABLA =========
    function renderizarTabla(usuariosToShow = null) {
      const tbody = document.getElementById("usuariosTableBody");
      tbody.innerHTML = "";

      const usuarios = usuariosToShow || getUsuariosProductores();

      if (usuarios.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:2rem;">No hay usuarios (productores) registrados.</td></tr>`;
        return;
      }

      usuarios.forEach(usuario => {
        const rol = (usuario.rol || "productor").toLowerCase();
        const roleClass = rol === "admin"
          ? "role-admin"
          : rol === "productor"
          ? "role-productor"
          : "role-conductor";

        const correo = usuario.email || usuario.correo || "sin_correo@agrolink.com";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${usuario.id}</td>
          <td>${usuario.nombre || "Sin nombre"}</td>
          <td>${correo}</td>
          <td><span class="role ${roleClass}">${rol.charAt(0).toUpperCase() + rol.slice(1)}</span></td>
          <td>${usuario.ultimoAcceso || "N/A"}</td>
          <td class="actions">
            <button class="edit-btn" data-id="${usuario.id}"><i class="fas fa-edit"></i></button>
            <button class="delete-btn" data-id="${usuario.id}"><i class="fas fa-trash"></i></button>
          </td>`;
        tbody.appendChild(row);
      });

      // Botones
      document.querySelectorAll(".delete-btn").forEach(btn =>
        btn.onclick = () => eliminarUsuario(btn.dataset.id)
      );
      document.querySelectorAll(".edit-btn").forEach(btn =>
        btn.onclick = () => abrirModalEdicion(btn.dataset.id)
      );
    }

    function eliminarUsuario(id) {
      if (!confirm("¬øEliminar este usuario (productor)?")) return;
      const listaProd = getUsuariosProductores().filter(u => u.id !== id);
      saveUsuariosProductores(listaProd);
      renderizarTabla();
      alert("‚úÖ Usuario eliminado correctamente.");
    }

    function abrirModalEdicion(id) {
      const u = getUsuariosProductores().find(x => x.id === id);
      if (!u) return;
      const correo = u.email || u.correo || "";
      document.getElementById("editId").value = u.id;
      document.getElementById("editNombre").value = u.nombre || "";
      document.getElementById("editCorreo").value = correo;
      document.getElementById("editRol").value = (u.rol || "productor").toLowerCase();
      document.getElementById("editUltimoAcceso").value = u.ultimoAcceso || "";
      document.getElementById("editModal").style.display = "flex";
    }

    // ========= INICIALIZACI√ìN Y EVENTOS =========
    window.onload = () => {
      // Proteger acceso solo admin
      const usuarioActivo = JSON.parse(localStorage.getItem("agrolinkUsuario") || "null");
      if (!usuarioActivo || (usuarioActivo.rol || "").toLowerCase() !== "admin") {
        alert("‚ö†Ô∏è Acceso restringido. Solo administradores pueden ver esta pantalla.");
        window.location.href = "../login.html";
        return;
      }

      // Pintar datos del admin
      const adminNameEl = document.getElementById("adminName");
      const adminAvatarEl = document.getElementById("adminAvatar");
      if (adminNameEl) adminNameEl.textContent = usuarioActivo.nombre || "Admin";
      if (adminAvatarEl) adminAvatarEl.textContent = (usuarioActivo.nombre || "A").charAt(0).toUpperCase();

      // Bot√≥n logout (solo cerrar sesi√≥n visual, no borrar DB)
      document.getElementById("btnLogout").addEventListener("click", (e) => {
        e.preventDefault();
        alert("üëã Sesi√≥n de administrador cerrada.");
        localStorage.removeItem("agrolinkUsuario");
        localStorage.removeItem("agrolinkRol");
        window.location.href = "../index.html";
      });

      // Buscar
      const btnBuscar = document.getElementById("btnBuscar");
      const filterNombre = document.getElementById("filterNombre");
      const filterRol = document.getElementById("filterRol");

      btnBuscar.onclick = () => {
        const nombre = (filterNombre.value || "").toLowerCase().trim();
        const rolFiltro = (filterRol.value || "").toLowerCase();

        const base = getUsuariosProductores();
        const filtrados = base.filter(u => {
          const nombreOk = !nombre || (u.nombre || "").toLowerCase().includes(nombre);
          const rolOk = !rolFiltro || (u.rol || "").toLowerCase() === rolFiltro;
          return nombreOk && rolOk;
        });

        renderizarTabla(filtrados);
      };

      // Modales
      const addModal = document.getElementById("addModal");
      const editModal = document.getElementById("editModal");
      const btnAgregar = document.getElementById("btnAgregar");
      const cancelAdd = document.getElementById("cancelAdd");
      const cancelEdit = document.getElementById("cancelEdit");

      btnAgregar.onclick = () => (addModal.style.display = "flex");
      cancelAdd.onclick = () => { addModal.style.display = "none"; document.getElementById("addForm").reset(); };
      cancelEdit.onclick = () => { editModal.style.display = "none"; document.getElementById("editForm").reset(); };
      document.querySelectorAll(".close-modal").forEach(btn =>
        btn.onclick = () => btn.closest(".modal").style.display = "none"
      );

      // Agregar
      const addForm = document.getElementById("addForm");
      addForm.onsubmit = e => {
        e.preventDefault();
        const listaProd = getUsuariosProductores();

        const nuevo = {
          id: "USR-" + Date.now().toString().slice(-6) + "-" + Math.floor(Math.random() * 1000),
          nombre: document.getElementById("addNombre").value.trim(),
          correo: document.getElementById("addCorreo").value.trim().toLowerCase(),
          email: document.getElementById("addCorreo").value.trim().toLowerCase(),
          rol: "productor",
          ultimoAcceso: document.getElementById("addUltimoAcceso").value.trim() || "N/A",
          // password vac√≠o porque este usuario se cre√≥ desde admin (si quieres, luego puedes darle una contrase√±a)
        };

        listaProd.push(nuevo);
        saveUsuariosProductores(listaProd);
        renderizarTabla();
        addModal.style.display = "none";
        addForm.reset();
        alert("‚úÖ Usuario productor agregado correctamente.");
      };

      // Editar
      const editForm = document.getElementById("editForm");
      editForm.onsubmit = e => {
        e.preventDefault();
        const id = document.getElementById("editId").value;
        let listaProd = getUsuariosProductores();
        const i = listaProd.findIndex(x => x.id === id);
        if (i >= 0) {
          const correoNuevo = document.getElementById("editCorreo").value.trim().toLowerCase();
          listaProd[i] = {
            ...listaProd[i],
            nombre: document.getElementById("editNombre").value.trim(),
            correo: correoNuevo,
            email: correoNuevo,
            rol: "productor",
            ultimoAcceso: document.getElementById("editUltimoAcceso").value.trim() || listaProd[i].ultimoAcceso || "N/A"
          };
          saveUsuariosProductores(listaProd);
          renderizarTabla();
          editModal.style.display = "none";
          editForm.reset();
          alert("‚úÖ Usuario actualizado correctamente.");
        }
      };

      // Eliminar todos (solo productores)
      const btnEliminar = document.getElementById("btnEliminar");
      btnEliminar.onclick = () => {
        if (confirm("¬øEliminar TODOS los usuarios productores? Esta acci√≥n no se puede deshacer.")) {
          saveUsuariosProductores([]); // borramos solo productores, no admin ni transportistas
          renderizarTabla();
          alert("üóëÔ∏è Se eliminaron todos los usuarios productores.");
        }
      };

      // Primera carga
      renderizarTabla();
    };
  </script>
</body>
</html>
