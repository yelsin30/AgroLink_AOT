<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgroLink - Reportes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/Admin/reportes.css" />
  <style>
    .chart { display: flex; align-items: flex-end; gap: 10px; height: 200px; margin-top: 1rem; }
    .bar { width: 30px; background-color: #22c55e; border-radius: 4px 4px 0 0; transition: height 0.5s; position: relative; }
    .bar::after { content: attr(data-label); position: absolute; bottom: -20px; width: 100%; text-align: center; font-size: 0.8rem; color: #555; }
    .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
    .header { background: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
    .header-title { display: flex; align-items: center; gap: 0.75rem; color: #22c55e; }
    .header-title h1 { font-size: 1.5rem; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-truck"></i>
      <h1>AgroLink</h1>
    </div>
    <nav class="nav-menu">
      <a href="admin.html" class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
      <a href="envios.html" class="nav-item"><i class="fas fa-truck"></i><span>Env칤os</span></a>
      <a href="transportistas.html" class="nav-item"><i class="fas fa-users"></i><span>Transportistas</span></a>
      <a href="productos.html" class="nav-item"><i class="fas fa-box"></i><span>Productos</span></a>
      <a href="usuarios.html" class="nav-item"><i class="fas fa-user"></i><span>Usuarios</span></a>
      <a href="reportes.html" class="nav-item active"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
      <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuraci칩n</span></a>
      <a href="../index.html" class="nav-item logout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi칩n</span></a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="header">
      <div class="header-title">
        <i class="fas fa-chart-bar"></i>
        <h1>Reportes</h1>
      </div>
      <div class="user-profile">
        <div class="avatar">A</div>
        <span class="username">Admin</span>
      </div>
    </header>

    <div class="report-grid">
      <div class="card">
        <h2>游닍 Env칤os por Mes</h2>
        <div id="chartEnvios" class="chart"></div>
      </div>

      <div class="card">
        <h2>游 Productos M치s Enviados</h2>
        <div id="chartProductos" class="chart"></div>
      </div>

      <div class="card">
        <h2>游뚴 Transportistas Activos</h2>
        <div id="transportistasActivos" style="font-size:3rem;font-weight:700;text-align:center;margin-top:2rem;">0</div>
      </div>

      <div class="card">
        <h2>游눯 Ingresos Estimados</h2>
        <div id="ingresosEstimados" style="font-size:2.5rem;font-weight:700;color:#22c55e;text-align:center;margin-top:2rem;">S/ 0.00</div>
      </div>
    </div>
  </main>

  <script>
    // === Obtener datos de localStorage ===
    function getEnvios() {
      return JSON.parse(localStorage.getItem("agrolink_envios") || "[]");
    }

    function getProductos() {
      return JSON.parse(localStorage.getItem("agrolink_productos") || "[]");
    }

    function getTransportistas() {
      return JSON.parse(localStorage.getItem("agrolink_transportistas") || "[]");
    }

    // === Env칤os por mes ===
    function generarEnviosPorMes() {
      const envios = getEnvios();
      const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
      const conteo = new Array(12).fill(0);

      envios.forEach(e => {
        if (e.fecha) {
          const partes = e.fecha.split("/");
          const mes = parseInt(partes[1]) - 1;
          if (!isNaN(mes) && mes >= 0 && mes < 12) conteo[mes]++;
        }
      });

      const chart = document.getElementById("chartEnvios");
      chart.innerHTML = "";
      conteo.forEach((v, i) => {
        const bar = document.createElement("div");
        bar.className = "bar";
        const height = (v / Math.max(...conteo, 1)) * 100;
        bar.style.height = height + "%";
        bar.setAttribute("data-label", meses[i]);
        chart.appendChild(bar);
      });
    }

    // === Productos m치s enviados ===
    function generarProductosMasEnviados() {
      const envios = getEnvios();
      const conteo = {};

      envios.forEach(e => {
        if (e.producto) conteo[e.producto] = (conteo[e.producto] || 0) + 1;
      });

      const top = Object.entries(conteo)
        .sort((a,b) => b[1]-a[1])
        .slice(0,5);

      const chart = document.getElementById("chartProductos");
      chart.innerHTML = "";

      top.forEach(([nombre, cantidad]) => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = (cantidad / top[0][1]) * 100 + "%";
        bar.setAttribute("data-label", nombre);
        chart.appendChild(bar);
      });
    }

    // === Transportistas activos ===
    function mostrarTransportistasActivos() {
      const t = getTransportistas();
      document.getElementById("transportistasActivos").innerText = t.length;
    }

    // === Ingresos estimados ===
    function calcularIngresosEstimados() {
      const productos = getProductos();
      let total = 0;
      productos.forEach(p => {
        if (p.estado === "disponible") {
          total += parseFloat(p.precio || 0) * parseFloat(p.stock || 0);
        }
      });
      document.getElementById("ingresosEstimados").innerText = "S/ " + total.toFixed(2);
    }

    // === Inicializar reportes ===
    window.onload = () => {
      generarEnviosPorMes();
      generarProductosMasEnviados();
      mostrarTransportistasActivos();
      calcularIngresosEstimados();
    };
  </script>
</body>
</html>
