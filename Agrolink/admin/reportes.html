<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgroLink - Reportes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/Admin/reportes.css" />

</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="fa-solid fa-tractor"></i>
      <h1>AgroLink</h1>
    </div>
    <nav class="nav-menu">
      <a href="admin.html" class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
      <a href="envios.html" class="nav-item"><i class="fas fa-truck"></i><span>EnvÃ­os</span></a>
      <a href="transportistas.html" class="nav-item"><i class="fas fa-users"></i><span>Transportistas</span></a>
      <a href="productos.html" class="nav-item"><i class="fas fa-box"></i><span>Productos</span></a>
      <a href="usuarios.html" class="nav-item"><i class="fas fa-user"></i><span>Usuarios</span></a>
      <a href="reportes.html" class="nav-item active"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
      <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>ConfiguraciÃ³n</span></a>
      <a href="../index.html" class="nav-item logout"><i class="fas fa-sign-out-alt"></i><span>Cerrar SesiÃ³n</span></a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="header">
      <div class="header-title">
        <i class="fas fa-chart-bar"></i>
        <h1>Reportes Generales</h1>
      </div>
      <div class="user-profile">
        <div class="avatar" id="adminAvatar">A</div>
        <span class="username" id="adminName">Admin</span>
      </div>
    </header>

    <div class="report-grid">
      <div class="card">
        <h2>ðŸ“¦ EnvÃ­os por Mes</h2>
        <div id="chartEnvios" class="chart"></div>
      </div>

      <div class="card">
        <h2>ðŸŒ¾ Productos MÃ¡s Enviados</h2>
        <div id="chartProductos" class="chart"></div>
      </div>

      <div class="card">
        <h2>ðŸšš Transportistas Activos</h2>
        <div id="transportistasActivos" style="font-size:3rem;font-weight:700;text-align:center;margin-top:2rem;">0</div>
      </div>

      <div class="card">
        <h2>ðŸ’° Ingresos Estimados</h2>
        <div id="ingresosEstimados" style="font-size:2.5rem;font-weight:700;color:#22c55e;text-align:center;margin-top:2rem;">S/ 0.00</div>
      </div>
    </div>
  </main>

  <script>
    /* === VALIDAR SESIÃ“N ADMIN === */
    const usuarioActivo = JSON.parse(localStorage.getItem("agrolinkUsuario") || "null");
    if (!usuarioActivo || (usuarioActivo.rol || "").toLowerCase() !== "admin") {
      alert("âš ï¸ Acceso restringido. Solo los administradores pueden ver los reportes.");
      window.location.href = "../login.html";
    } else {
      document.getElementById("adminName").textContent = usuarioActivo.nombre || "Admin";
      document.getElementById("adminAvatar").textContent = (usuarioActivo.nombre || "A").charAt(0).toUpperCase();
    }

    /* === FUENTES DE DATOS === */
    const KEY_SOLICITUDES = "solicitudesAgroLink";
    const KEY_USUARIOS = "agrolinkUsuarios";
    const KEY_PRODUCTOS = "agrolink_productos";

    function getEnvios() {
      return JSON.parse(localStorage.getItem(KEY_SOLICITUDES) || "[]");
    }

    function getUsuarios() {
      return JSON.parse(localStorage.getItem(KEY_USUARIOS) || "[]");
    }

    function getProductos() {
      return JSON.parse(localStorage.getItem(KEY_PRODUCTOS) || "[]");
    }

    /* === ðŸ“¦ EnvÃ­os por Mes === */
    function generarEnviosPorMes() {
      const envios = getEnvios();
      const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
      const conteo = new Array(12).fill(0);

      envios.forEach(v => {
        const fecha = v.fecha || v.fechaCompletado || "";
        const mes = parseInt((fecha.split("/")[1] || fecha.split("-")[1] || "0")) - 1;
        if (!isNaN(mes) && mes >= 0 && mes < 12) conteo[mes]++;
      });

      const chart = document.getElementById("chartEnvios");
      chart.innerHTML = "";
      const maxVal = Math.max(...conteo, 1);

      conteo.forEach((v, i) => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = (v / maxVal) * 100 + "%";
        bar.setAttribute("data-label", meses[i]);
        chart.appendChild(bar);
      });
    }

    /* === ðŸŒ¾ Productos MÃ¡s Enviados === */
    function generarProductosMasEnviados() {
      const envios = getEnvios();
      const conteo = {};
      envios.forEach(v => {
        const nombre = v.tipo || v.producto;
        if (nombre) conteo[nombre] = (conteo[nombre] || 0) + 1;
      });

      const top = Object.entries(conteo)
        .sort((a,b) => b[1]-a[1])
        .slice(0,5);

      const chart = document.getElementById("chartProductos");
      chart.innerHTML = "";

      if (top.length === 0) {
        chart.innerHTML = "<p style='color:#777;font-size:0.9rem;'>No hay datos disponibles</p>";
        return;
      }

      top.forEach(([nombre, cantidad]) => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = (cantidad / top[0][1]) * 100 + "%";
        bar.setAttribute("data-label", nombre.length > 5 ? nombre.slice(0,5) + "â€¦" : nombre);
        chart.appendChild(bar);
      });
    }

    /* === ðŸšš Transportistas Activos === */
    function mostrarTransportistasActivos() {
      const usuarios = getUsuarios();
      const activos = usuarios.filter(u => (u.rol || "").toLowerCase() === "transportista");
      document.getElementById("transportistasActivos").innerText = activos.length;
    }

    /* === ðŸ’° Ingresos Estimados === */
    function calcularIngresosEstimados() {
      const envios = getEnvios();
      let total = 0;
      envios.forEach(v => {
        if (/(entregado|completado)/i.test(v.estado || "")) {
          total += parseFloat(v.pagoFinal || v.pago || 0);
        }
      });
      document.getElementById("ingresosEstimados").innerText = "S/ " + total.toFixed(2);
    }

    /* === AUTO-REFRESH AL CAMBIAR LOCALSTORAGE === */
    window.addEventListener("storage", e => {
      if ([KEY_SOLICITUDES, KEY_USUARIOS, KEY_PRODUCTOS].includes(e.key)) {
        generarEnviosPorMes();
        generarProductosMasEnviados();
        mostrarTransportistasActivos();
        calcularIngresosEstimados();
      }
    });

    /* === INICIALIZAR === */
    window.onload = () => {
      generarEnviosPorMes();
      generarProductosMasEnviados();
      mostrarTransportistasActivos();
      calcularIngresosEstimados();
    };
  </script>
</body>
</html>
