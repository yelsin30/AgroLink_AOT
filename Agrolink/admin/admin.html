<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgroLink - Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/Admin/admin.css" />
</head>
<body>
  <!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-header">
    <i class="fa-solid fa-tractor"></i>
    <h1>AgroLink</h1>
  </div>
  <nav class="nav-menu">
    <a href="admin.html" class="nav-item active"><i class="fas fa-home"></i><span>Dashboard</span></a>
    <a href="envios.html" class="nav-item"><i class="fas fa-truck"></i><span>Env√≠os</span></a>
    <a href="transportistas.html" class="nav-item"><i class="fas fa-users"></i><span>Transportistas</span></a>
    <a href="productos.html" class="nav-item"><i class="fas fa-box"></i><span>Productos</span></a>
    <a href="usuarios.html" class="nav-item"><i class="fas fa-user"></i><span>Usuarios</span></a>
    <a href="reportes.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
    <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuraci√≥n</span></a>
    <a href="../index.html" class="nav-item logout" id="btnLogout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi√≥n</span></a>
  </nav>
</aside>


  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <div class="header-title">
        <i class="fas fa-gauge-high"></i>
        <h1>AgroLink Admin</h1>
      </div>
      <div class="user-profile">
        <div class="avatar" id="adminAvatar">A</div>
        <span class="username" id="adminName">Admin</span>
      </div>
    </header>

    <!-- Dashboard Card -->
    <div class="dashboard-card">
      <h2>Panel de Control</h2>
      <p>Gesti√≥n centralizada de env√≠os, transportistas y productos.</p>
    </div>

    <!-- Stats -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-value" id="totalEnvios">0</div>
        <div class="stat-label">Env√≠os Totales</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="enviosPendientes">0</div>
        <div class="stat-label">Pendientes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="enviosEnCurso">0</div>
        <div class="stat-label">En curso</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="enviosEntregados">0</div>
        <div class="stat-label">Entregados</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalTransportistas">0</div>
        <div class="stat-label">Transportistas</div>
      </div>
    </div>

    <!-- Actividad reciente -->
    <div class="recent-activity">
      <h2>Actividad Reciente</h2>
      <ul class="activity-list" id="activityList"></ul>
    </div>
  </main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    /* ========== SESI√ìN ADMIN ========== */
    const usuarioActivo = JSON.parse(localStorage.getItem("agrolinkUsuario") || "null");
    if (!usuarioActivo || (usuarioActivo.rol || "").toLowerCase() !== "admin") {
      alert("‚ö†Ô∏è Acceso restringido. Solo los administradores pueden ver este panel.");
      window.location.href = "../login.html";
      return;
    }
    document.getElementById("adminName").textContent = usuarioActivo.nombre || "Admin";
    document.getElementById("adminAvatar").textContent = (usuarioActivo.nombre || "A").charAt(0).toUpperCase();

    document.getElementById("btnLogout").addEventListener("click", (e) => {
      e.preventDefault();
      alert("üëã Sesi√≥n de administrador cerrada.");
      localStorage.removeItem("agrolinkUsuario");
      localStorage.removeItem("agrolinkRol");
      window.location.href = "../index.html";
    });

    /* ========== FUENTES DE DATOS (LS) ========== */
    const KEY_SOLICITUDES = "solicitudesAgroLink";
    const KEY_ENV_BACKUP = "agrolink_envios"; // respaldo opcional
    const KEY_USUARIOS = "agrolinkUsuarios";

    function getUsuarios() {
      return JSON.parse(localStorage.getItem(KEY_USUARIOS) || "[]");
    }

    // Une solicitudesAgroLink + agrolink_envios (sin duplicar IDs)
    function getEnvios() {
      const a = JSON.parse(localStorage.getItem(KEY_SOLICITUDES) || "[]");
      const b = JSON.parse(localStorage.getItem(KEY_ENV_BACKUP) || "[]");
      const map = new Map();
      [...a, ...b].forEach((e, idx) => {
        const id = e.id || `ENV-${Date.now()}-${idx}`;
        if (!map.has(id)) {
          map.set(id, { ...e, id });
        }
      });
      return Array.from(map.values());
    }

    /* ========== ESTAD√çSTICAS ========== */
    function actualizarEstadisticas() {
      const envios = getEnvios();
      const usuarios = getUsuarios();
      const transportistas = usuarios.filter(u => (u.rol || "").toLowerCase() === "transportista");

      const totalEnvios = envios.length;
      const pendientes = envios.filter(e => /pendiente/i.test(e.estado || "")).length;
      const enCurso = envios.filter(e => /(en\s*curso|en\s*tr[a√°]nsito)/i.test(e.estado || "")).length;
      const entregados = envios.filter(e => /(entregado|completado)/i.test(e.estado || "")).length;

      document.getElementById("totalEnvios").textContent = totalEnvios;
      document.getElementById("enviosPendientes").textContent = pendientes;
      document.getElementById("enviosEnCurso").textContent = enCurso;
      document.getElementById("enviosEntregados").textContent = entregados;
      document.getElementById("totalTransportistas").textContent = transportistas.length;
    }

    /* ========== ACTIVIDAD RECIENTE ========== */
    function actualizarActividad() {
      const envios = getEnvios();
      const activityList = document.getElementById("activityList");
      activityList.innerHTML = "";

      if (envios.length === 0) {
        activityList.innerHTML = `<li class="activity-item"><i class="fas fa-info-circle"></i> No hay actividad registrada.</li>`;
        return;
      }

      const recientes = envios.slice(-8).reverse();
      recientes.forEach(e => {
        let icono = "fa-truck text-primary";
        if (/pendiente/i.test(e.estado || "")) icono = "fa-clock text-warning";
        if (/(entregado|completado)/i.test(e.estado || "")) icono = "fa-circle-check text-success";
        if (/(en\s*curso|en\s*tr[a√°]nsito)/i.test(e.estado || "")) icono = "fa-route text-info";

        const fechaTxt = e.fecha || "";
        const li = document.createElement("li");
        li.classList.add("activity-item");
        li.innerHTML = `
          <i class="fas ${icono}"></i>
          <strong>${e.id}</strong>
          ‚Äî ${e.origen || "?"} ‚Üí ${e.destino || "?"}
          <small style="color:#6b7280;"> (${e.estado || "Sin estado"}${fechaTxt ? " ‚Ä¢ " + fechaTxt : ""})</small>
        `;
        li.style.cursor = "pointer";
        li.title = "Ver en Env√≠os";
        li.addEventListener("click", () => window.location.href = "envios.html");
        activityList.appendChild(li);
      });
    }

    /* ========== AUTO-REFRESH SI CAMBIA EL LS ========== */
    window.addEventListener("storage", (e) => {
      if ([KEY_SOLICITUDES, KEY_ENV_BACKUP, KEY_USUARIOS].includes(e.key)) {
        actualizarEstadisticas();
        actualizarActividad();
      }
    });

    /* ========== INICIALIZAR ========== */
    actualizarEstadisticas();
    actualizarActividad();
  });
</script>

</body>
</html>
