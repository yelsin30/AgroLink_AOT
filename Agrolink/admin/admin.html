<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgroLink - Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/Admin/admin.css" />
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-truck"></i>
      <h1>AgroLink</h1>
    </div>
    <nav class="nav-menu">
      <a href="admin.html" class="nav-item active"><i class="fas fa-home"></i><span>Dashboard</span></a>
      <a href="envios.html" class="nav-item"><i class="fas fa-truck"></i><span>Env√≠os</span></a>
      <a href="transportistas.html" class="nav-item"><i class="fas fa-users"></i><span>Transportistas</span></a>
      <a href="productos.html" class="nav-item"><i class="fas fa-box"></i><span>Productos</span></a>
      <a href="usuarios.html" class="nav-item"><i class="fas fa-user"></i><span>Usuarios</span></a>
      <a href="reportes.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
      <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuraci√≥n</span></a>
      <a href="../index.html" class="nav-item logout" id="btnLogout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi√≥n</span></a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <div class="header-title">
        <i class="fas fa-gauge-high"></i>
        <h1>AgroLink Admin</h1>
      </div>
      <div class="user-profile">
        <div class="avatar" id="adminAvatar">A</div>
        <span class="username" id="adminName">Admin</span>
      </div>
    </header>

    <!-- Dashboard Card -->
    <div class="dashboard-card">
      <h2>Panel de Control</h2>
      <p>Gesti√≥n centralizada de env√≠os, transportistas y productos.</p>
    </div>

    <!-- Stats -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-value" id="totalEnvios">0</div>
        <div class="stat-label">Env√≠os Totales</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="enviosPendientes">0</div>
        <div class="stat-label">Pendientes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="enviosEntregados">0</div>
        <div class="stat-label">Entregados</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalTransportistas">0</div>
        <div class="stat-label">Transportistas</div>
      </div>
    </div>

    <!-- Actividad reciente -->
    <div class="recent-activity">
      <h2>Actividad Reciente</h2>
      <ul class="activity-list" id="activityList"></ul>
    </div>
  </main>

<script>
  document.addEventListener("DOMContentLoaded", () => {

    // ======== FUNCIONES DE BASE DE DATOS ========
    function getEnvios() {
      return JSON.parse(localStorage.getItem("agrolink_envios") || "[]");
    }

    function getUsuarios() {
      return JSON.parse(localStorage.getItem("agrolinkUsuarios") || "[]");
    }

    // ======== MOSTRAR ESTAD√çSTICAS ========
    function actualizarEstadisticas() {
      const envios = getEnvios();
      const usuarios = getUsuarios();

      const transportistas = usuarios.filter(u => (u.rol || "").toLowerCase() === "transportista");

      // Totales
      const totalEnvios = envios.length;
      const pendientes = envios.filter(e => /pendiente/i.test(e.estado || "")).length;
      const entregados = envios.filter(e => /entregado|completado/i.test(e.estado || "")).length;
      const totalTransportistas = transportistas.length;

      // Mostrar
      document.getElementById("totalEnvios").textContent = totalEnvios;
      document.getElementById("enviosPendientes").textContent = pendientes;
      document.getElementById("enviosEntregados").textContent = entregados;
      document.getElementById("totalTransportistas").textContent = totalTransportistas;
    }

    // ======== ACTIVIDAD RECIENTE ========
    function actualizarActividad() {
      const envios = getEnvios();
      const activityList = document.getElementById("activityList");
      activityList.innerHTML = "";

      if (envios.length === 0) {
        activityList.innerHTML = `<li class="activity-item"><i class="fas fa-info-circle"></i> No hay actividad registrada.</li>`;
        return;
      }

      const recientes = envios.slice(-5).reverse();
      recientes.forEach(e => {
        let icono = "fa-truck text-primary";
        if (/pendiente/i.test(e.estado)) icono = "fa-clock text-warning";
        if (/entregado|completado/i.test(e.estado)) icono = "fa-circle-check text-success";

        const li = document.createElement("li");
        li.classList.add("activity-item");
        li.innerHTML = `
          <i class="fas ${icono}"></i>
          <strong>${e.id || "ENV-" + Math.random().toString(36).slice(2,6)}</strong>
          ‚Äî ${e.origen || "?"} ‚Üí ${e.destino || "?"}
          <small style="color:#6b7280;"> (${e.estado || "Sin estado"})</small>
        `;
        activityList.appendChild(li);
      });
    }

    // ======== VALIDAR SESI√ìN ADMIN ========
    const usuarioActivo = JSON.parse(localStorage.getItem("agrolinkUsuario") || "null");
    if (!usuarioActivo || (usuarioActivo.rol || "").toLowerCase() !== "admin") {
      alert("‚ö†Ô∏è Acceso restringido. Solo los administradores pueden ver este panel.");
      window.location.href = "../login.html";
      return;
    }

    document.getElementById("adminName").textContent = usuarioActivo.nombre || "Admin";
    document.getElementById("adminAvatar").textContent = (usuarioActivo.nombre || "A").charAt(0).toUpperCase();

    // ======== LOGOUT ========
    document.getElementById("btnLogout").addEventListener("click", (e) => {
      e.preventDefault();
      alert("üëã Sesi√≥n de administrador cerrada.");
      localStorage.removeItem("agrolinkUsuario");
      localStorage.removeItem("agrolinkRol");
      window.location.href = "../index.html";
    });

    // ======== INICIALIZAR ========
    actualizarEstadisticas();
    actualizarActividad();
  });
</script>

</body>
</html>
