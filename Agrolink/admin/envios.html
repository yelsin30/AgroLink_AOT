<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgroLink - Gesti√≥n de Env√≠os</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/Admin/envios.css" />
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-truck"></i>
      <h1>AgroLink</h1>
    </div>
    <nav class="nav-menu">
      <a href="admin.html" class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
      <a href="envios.html" class="nav-item active"><i class="fas fa-truck"></i><span>Env√≠os</span></a>
      <a href="transportistas.html" class="nav-item"><i class="fas fa-users"></i><span>Transportistas</span></a>
      <a href="productos.html" class="nav-item"><i class="fas fa-box"></i><span>Productos</span></a>
      <a href="usuarios.html" class="nav-item"><i class="fas fa-user"></i><span>Usuarios</span></a>
      <a href="reportes.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
      <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuraci√≥n</span></a>
      <a href="../index.html" class="nav-item logout" id="btnLogout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi√≥n</span></a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <div class="header-title">
        <i class="fas fa-truck"></i>
        <h1>Gesti√≥n de Env√≠os</h1>
      </div>
      <div class="user-profile">
        <div class="avatar" id="adminAvatar">A</div>
        <span class="username" id="adminName">Admin</span>
      </div>
    </header>

    <!-- Filtros -->
    <div class="search-filters">
      <h2>Filtros de b√∫squeda</h2>
      <div class="filters-container">
        <div class="filter-input"><input type="text" placeholder="Origen" id="filterOrigen" /></div>
        <div class="filter-input"><input type="text" placeholder="Destino" id="filterDestino" /></div>
        <div class="filter-input">
          <select id="filterEstado">
            <option value="">Todos los estados</option>
            <option value="Pendiente">Pendiente</option>
            <option value="En tr√°nsito">En tr√°nsito</option>
            <option value="Entregado">Entregado</option>
          </select>
        </div>
        <button class="filter-button" id="btnBuscar"><i class="fas fa-search"></i> Buscar</button>
      </div>
    </div>

    <!-- Botones -->
    <div class="action-buttons">
      <button class="btn btn-add" id="btnAgregar"><i class="fas fa-plus"></i>Agregar Env√≠o</button>
      <button class="btn btn-delete" id="btnEliminar"><i class="fas fa-trash"></i>Eliminar Todos</button>
    </div>

    <!-- Tabla -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Origen</th>
            <th>Destino</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Transportista</th>
            <th>Producto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="enviosTableBody"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Agregar -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Agregar Nuevo Env√≠o</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="addForm">
        <div class="form-group"><label>ID</label><input type="text" id="addId" placeholder="Ej. SHP-001" /></div>
        <div class="form-group"><label>Origen</label><input type="text" id="addOrigen" required /></div>
        <div class="form-group"><label>Destino</label><input type="text" id="addDestino" required /></div>
        <div class="form-group"><label>Estado</label>
          <select id="addEstado" required>
            <option value="Pendiente">Pendiente</option>
            <option value="En tr√°nsito">En tr√°nsito</option>
            <option value="Entregado">Entregado</option>
          </select>
        </div>
        <div class="form-group"><label>Fecha</label><input type="text" id="addFecha" placeholder="dd/mm/aaaa" required /></div>
        <div class="form-group"><label>Transportista</label><input type="text" id="addTransportista" required /></div>
        <div class="form-group"><label>Producto</label><input type="text" id="addProducto" required /></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" id="cancelAdd">Cancelar</button>
          <button type="submit" class="btn btn-add">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Env√≠o</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editId" />
        <div class="form-group"><label>Origen</label><input type="text" id="editOrigen" required /></div>
        <div class="form-group"><label>Destino</label><input type="text" id="editDestino" required /></div>
        <div class="form-group"><label>Estado</label>
          <select id="editEstado" required>
            <option value="Pendiente">Pendiente</option>
            <option value="En tr√°nsito">En tr√°nsito</option>
            <option value="Entregado">Entregado</option>
          </select>
        </div>
        <div class="form-group"><label>Fecha</label><input type="text" id="editFecha" required /></div>
        <div class="form-group"><label>Transportista</label><input type="text" id="editTransportista" required /></div>
        <div class="form-group"><label>Producto</label><input type="text" id="editProducto" required /></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" id="cancelEdit">Cancelar</button>
          <button type="submit" class="btn btn-add">Actualizar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ======= BASE DE DATOS =======
    const STORAGE_KEY = "agrolink_envios";

    function getEnvios() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }

    function saveEnvios(envios) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(envios));
    }

    // ======= RENDERIZAR TABLA =======
    function renderizarTabla(enviosToShow = null) {
      const tbody = document.getElementById("enviosTableBody");
      tbody.innerHTML = "";
      const envios = enviosToShow || getEnvios();

      if (envios.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem;">No hay env√≠os registrados.</td></tr>`;
        return;
      }

      envios.forEach(e => {
        const row = document.createElement("tr");
        const estadoClase = e.estado === "Entregado"
          ? "status-delivered"
          : e.estado === "En tr√°nsito"
          ? "status-transit"
          : "status-pending";

        row.innerHTML = `
          <td>${e.id}</td>
          <td>${e.origen}</td>
          <td>${e.destino}</td>
          <td><span class="status ${estadoClase}">${e.estado}</span></td>
          <td>${e.fecha}</td>
          <td>${e.transportista}</td>
          <td>${e.producto}</td>
          <td class="actions">
            <button class="view-btn" data-id="${e.id}"><i class="fas fa-eye"></i></button>
            <button class="edit-btn" data-id="${e.id}"><i class="fas fa-edit"></i></button>
            <button class="delete-btn" data-id="${e.id}"><i class="fas fa-trash"></i></button>
          </td>`;
        tbody.appendChild(row);
      });

      document.querySelectorAll(".delete-btn").forEach(b => b.onclick = () => eliminarEnvio(b.dataset.id));
      document.querySelectorAll(".edit-btn").forEach(b => b.onclick = () => abrirModalEdicion(b.dataset.id));
      document.querySelectorAll(".view-btn").forEach(b => b.onclick = () => verEnvio(b.dataset.id));
    }

    // ======= FUNCIONES CRUD =======
    function eliminarEnvio(id) {
      if (!confirm("¬øEliminar este env√≠o?")) return;
      const envios = getEnvios().filter(e => e.id !== id);
      saveEnvios(envios);
      renderizarTabla();
    }

    function abrirModalEdicion(id) {
      const e = getEnvios().find(x => x.id === id);
      if (!e) return;
      document.getElementById("editId").value = e.id;
      document.getElementById("editOrigen").value = e.origen;
      document.getElementById("editDestino").value = e.destino;
      document.getElementById("editEstado").value = e.estado;
      document.getElementById("editFecha").value = e.fecha;
      document.getElementById("editTransportista").value = e.transportista;
      document.getElementById("editProducto").value = e.producto;
      document.getElementById("editModal").style.display = "flex";
    }

    function verEnvio(id) {
      const e = getEnvios().find(x => x.id === id);
      if (!e) return;
      alert(`üì¶ Env√≠o ${e.id}\nOrigen: ${e.origen}\nDestino: ${e.destino}\nEstado: ${e.estado}\nFecha: ${e.fecha}\nTransportista: ${e.transportista}\nProducto: ${e.producto}`);
    }

    // ======= FILTROS =======
    document.getElementById("btnBuscar").onclick = () => {
      const origen = document.getElementById("filterOrigen").value.trim().toLowerCase();
      const destino = document.getElementById("filterDestino").value.trim().toLowerCase();
      const estado = document.getElementById("filterEstado").value;

      const filtrados = getEnvios().filter(e =>
        (!origen || e.origen.toLowerCase().includes(origen)) &&
        (!destino || e.destino.toLowerCase().includes(destino)) &&
        (!estado || e.estado === estado)
      );
      renderizarTabla(filtrados);
    };

    // ======= MODALES =======
    const addModal = document.getElementById("addModal");
    const editModal = document.getElementById("editModal");

    document.getElementById("btnAgregar").onclick = () => addModal.style.display = "flex";
    document.getElementById("cancelAdd").onclick = () => { addModal.style.display = "none"; addForm.reset(); };
    document.getElementById("cancelEdit").onclick = () => { editModal.style.display = "none"; editForm.reset(); };
    document.querySelectorAll(".close-modal").forEach(btn => btn.onclick = () => btn.closest(".modal").style.display = "none");

    // ======= AGREGAR / EDITAR =======
    addForm.onsubmit = e => {
      e.preventDefault();
      const nuevo = {
        id: document.getElementById("addId").value || "SHP-" + Date.now(),
        origen: document.getElementById("addOrigen").value.trim(),
        destino: document.getElementById("addDestino").value.trim(),
        estado: document.getElementById("addEstado").value,
        fecha: document.getElementById("addFecha").value.trim(),
        transportista: document.getElementById("addTransportista").value.trim(),
        producto: document.getElementById("addProducto").value.trim()
      };
      const lista = [...getEnvios(), nuevo];
      saveEnvios(lista);
      renderizarTabla();
      addModal.style.display = "none";
      addForm.reset();
      alert("‚úÖ Env√≠o agregado correctamente.");
    };

    editForm.onsubmit = e => {
      e.preventDefault();
      const id = document.getElementById("editId").value;
      let lista = getEnvios();
      const i = lista.findIndex(x => x.id === id);
      if (i >= 0) {
        lista[i] = {
          ...lista[i],
          origen: document.getElementById("editOrigen").value.trim(),
          destino: document.getElementById("editDestino").value.trim(),
          estado: document.getElementById("editEstado").value,
          fecha: document.getElementById("editFecha").value.trim(),
          transportista: document.getElementById("editTransportista").value.trim(),
          producto: document.getElementById("editProducto").value.trim()
        };
        saveEnvios(lista);
        renderizarTabla();
        editModal.style.display = "none";
        editForm.reset();
        alert("‚úÖ Env√≠o actualizado correctamente.");
      }
    };

    // ======= ELIMINAR TODOS =======
    document.getElementById("btnEliminar").onclick = () => {
      if (confirm("¬øEliminar todos los env√≠os? Esta acci√≥n no se puede deshacer.")) {
        localStorage.removeItem(STORAGE_KEY);
        renderizarTabla();
        alert("üóëÔ∏è Todos los env√≠os fueron eliminados.");
      }
    };

    // ======= INICIALIZACI√ìN =======
    window.onload = () => {
      const usuarioActivo = JSON.parse(localStorage.getItem("agrolinkUsuario") || "null");
      if (!usuarioActivo || (usuarioActivo.rol || "").toLowerCase() !== "admin") {
        alert("‚ö†Ô∏è Acceso restringido. Solo administradores pueden ver los env√≠os.");
        window.location.href = "../login.html";
        return;
      }

      document.getElementById("adminName").textContent = usuarioActivo.nombre || "Admin";
      document.getElementById("adminAvatar").textContent = (usuarioActivo.nombre || "A").charAt(0).toUpperCase();

      renderizarTabla();
    };
  </script>
</body>
</html>
