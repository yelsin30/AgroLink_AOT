<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgroLink - Gesti√≥n de Productos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/Admin/productos.css" />
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-truck"></i>
      <h1>AgroLink</h1>
    </div>
    <nav class="nav-menu">
      <a href="admin.html" class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
      <a href="envios.html" class="nav-item"><i class="fas fa-truck"></i><span>Env√≠os</span></a>
      <a href="transportistas.html" class="nav-item"><i class="fas fa-users"></i><span>Transportistas</span></a>
      <a href="productos.html" class="nav-item active"><i class="fas fa-box"></i><span>Productos</span></a>
      <a href="usuarios.html" class="nav-item"><i class="fas fa-user"></i><span>Usuarios</span></a>
      <a href="reportes.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
      <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuraci√≥n</span></a>
      <a href="../index.html" class="nav-item logout" id="btnLogout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi√≥n</span></a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <div class="header-title">
        <i class="fas fa-box"></i>
        <h1>Gesti√≥n de Productos</h1>
      </div>
      <div class="user-profile">
        <div class="avatar" id="adminAvatar">A</div>
        <span class="username" id="adminName">Admin</span>
      </div>
    </header>

    <!-- Filtros -->
    <div class="search-filters">
      <h2>Filtros de b√∫squeda</h2>
      <div class="filters-container">
        <div class="filter-input">
          <input type="text" placeholder="Nombre (Ej. Ma√≠z)" id="filterNombre" />
        </div>
        <div class="filter-input">
          <select id="filterCategoria">
            <option value="">Todas las categor√≠as</option>
            <option value="Cereales">Cereales</option>
            <option value="Legumbres">Legumbres</option>
            <option value="Tub√©rculos">Tub√©rculos</option>
          </select>
        </div>
        <button class="filter-button" id="btnBuscar">
          <i class="fas fa-search"></i> Buscar
        </button>
      </div>
    </div>

    <!-- Botones -->
    <div class="action-buttons">
      <button class="btn btn-add" id="btnAgregar"><i class="fas fa-plus"></i> Agregar Producto</button>
      <button class="btn btn-delete" id="btnEliminar"><i class="fas fa-trash"></i> Eliminar todos</button>
    </div>

    <!-- Tabla -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Stock (kg)</th>
            <th>Precio (S/)</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="productosTableBody"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Agregar -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Agregar Nuevo Producto</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="addForm">
        <div class="form-group"><label>Nombre</label><input type="text" id="addNombre" required /></div>
        <div class="form-group"><label>Categor√≠a</label>
          <select id="addCategoria" required>
            <option value="Cereales">Cereales</option>
            <option value="Legumbres">Legumbres</option>
            <option value="Tub√©rculos">Tub√©rculos</option>
          </select>
        </div>
        <div class="form-group"><label>Stock (kg)</label><input type="number" id="addStock" required /></div>
        <div class="form-group"><label>Precio (S/)</label><input type="number" step="0.01" id="addPrecio" required /></div>
        <div class="form-group"><label>Estado</label>
          <select id="addEstado" required>
            <option value="disponible">Disponible</option>
            <option value="agotado">Agotado</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" id="cancelAdd">Cancelar</button>
          <button type="submit" class="btn btn-add">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Producto</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editId" />
        <div class="form-group"><label>Nombre</label><input type="text" id="editNombre" required /></div>
        <div class="form-group"><label>Categor√≠a</label>
          <select id="editCategoria" required>
            <option value="Cereales">Cereales</option>
            <option value="Legumbres">Legumbres</option>
            <option value="Tub√©rculos">Tub√©rculos</option>
          </select>
        </div>
        <div class="form-group"><label>Stock (kg)</label><input type="number" id="editStock" required /></div>
        <div class="form-group"><label>Precio (S/)</label><input type="number" step="0.01" id="editPrecio" required /></div>
        <div class="form-group"><label>Estado</label>
          <select id="editEstado" required>
            <option value="disponible">Disponible</option>
            <option value="agotado">Agotado</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" id="cancelEdit">Cancelar</button>
          <button type="submit" class="btn btn-add">Actualizar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* === Validaci√≥n de sesi√≥n Admin === */
    const admin = JSON.parse(localStorage.getItem("agrolinkUsuario") || "null");
    if (!admin || (admin.rol || "").toLowerCase() !== "admin") {
      alert("‚ö†Ô∏è Solo los administradores pueden acceder a este panel.");
      window.location.href = "../login.html";
    } else {
      document.getElementById("adminName").textContent = admin.nombre || "Admin";
      document.getElementById("adminAvatar").textContent = (admin.nombre || "A").charAt(0).toUpperCase();
    }

    /* === Sincronizar productos de productores === */
    function syncProductosConAdmin() {
      const productosProd = JSON.parse(localStorage.getItem("productosAgroLink") || "[]");
      let productosAdmin = JSON.parse(localStorage.getItem("agrolink_productos") || "[]");

      productosProd.forEach(p => {
        const existe = productosAdmin.some(pa =>
          pa.nombre.toLowerCase() === (p.nombre || "").toLowerCase() &&
          pa.categoria === (p.categoria || "")
        );
        if (!existe) {
          productosAdmin.push({
            id: "PR-" + Date.now().toString().slice(-6),
            nombre: p.nombre || "Sin nombre",
            categoria: p.categoria || "Sin categor√≠a",
            stock: p.stock || 0,
            precio: p.precio || 0,
            estado: p.estado || "disponible"
          });
        }
      });

      localStorage.setItem("agrolink_productos", JSON.stringify(productosAdmin));
    }

    function getProductos() {
      return JSON.parse(localStorage.getItem("agrolink_productos") || "[]");
    }
    function saveProductos(data) {
      localStorage.setItem("agrolink_productos", JSON.stringify(data));
    }

    /* === Renderizar Tabla === */
    function renderizarTabla(lista = null) {
      const tbody = document.getElementById("productosTableBody");
      const productos = lista || getProductos();
      tbody.innerHTML = "";

      if (productos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:2rem;">No hay productos registrados.</td></tr>`;
        return;
      }

      productos.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>${p.categoria}</td>
          <td>${p.stock}</td>
          <td>S/ ${parseFloat(p.precio).toFixed(2)}</td>
          <td><span class="status ${p.estado === "disponible" ? "status-available" : "status-unavailable"}">${p.estado}</span></td>
          <td class="actions">
            <button class="edit-btn" data-id="${p.id}"><i class="fas fa-edit"></i></button>
            <button class="delete-btn" data-id="${p.id}"><i class="fas fa-trash"></i></button>
          </td>`;
        tbody.appendChild(row);
      });

      document.querySelectorAll(".edit-btn").forEach(btn => btn.onclick = () => abrirModalEdicion(btn.dataset.id));
      document.querySelectorAll(".delete-btn").forEach(btn => btn.onclick = () => eliminarProducto(btn.dataset.id));
    }

    function eliminarProducto(id) {
      if (!confirm("¬øEliminar este producto?")) return;
      const nuevos = getProductos().filter(p => p.id !== id);
      saveProductos(nuevos);
      renderizarTabla();
    }

    function abrirModalEdicion(id) {
      const p = getProductos().find(x => x.id === id);
      if (!p) return;
      editId.value = p.id;
      editNombre.value = p.nombre;
      editCategoria.value = p.categoria;
      editStock.value = p.stock;
      editPrecio.value = p.precio;
      editEstado.value = p.estado;
      editModal.style.display = "flex";
    }

    /* === Eventos === */
    btnBuscar.onclick = () => {
      const nombre = filterNombre.value.trim().toLowerCase();
      const categoria = filterCategoria.value;
      const filtrados = getProductos().filter(p =>
        (!nombre || p.nombre.toLowerCase().includes(nombre)) &&
        (!categoria || p.categoria === categoria)
      );
      renderizarTabla(filtrados);
    };

    btnAgregar.onclick = () => addModal.style.display = "flex";
    cancelAdd.onclick = () => { addModal.style.display = "none"; addForm.reset(); };
    cancelEdit.onclick = () => { editModal.style.display = "none"; editForm.reset(); };
    document.querySelectorAll(".close-modal").forEach(b => b.onclick = () => b.closest(".modal").style.display = "none");

    addForm.onsubmit = e => {
      e.preventDefault();
      const producto = {
        id: "PR-" + Date.now().toString().slice(-6),
        nombre: addNombre.value.trim(),
        categoria: addCategoria.value,
        stock: parseFloat(addStock.value),
        precio: parseFloat(addPrecio.value),
        estado: addEstado.value
      };
      const productos = getProductos();
      productos.push(producto);
      saveProductos(productos);
      renderizarTabla();
      addModal.style.display = "none";
      addForm.reset();
      alert("‚úÖ Producto agregado correctamente.");
    };

    editForm.onsubmit = e => {
      e.preventDefault();
      const id = editId.value;
      let productos = getProductos();
      const idx = productos.findIndex(p => p.id === id);
      if (idx >= 0) {
        productos[idx] = {
          id,
          nombre: editNombre.value,
          categoria: editCategoria.value,
          stock: parseFloat(editStock.value),
          precio: parseFloat(editPrecio.value),
          estado: editEstado.value
        };
        saveProductos(productos);
        renderizarTabla();
        editModal.style.display = "none";
        editForm.reset();
        alert("‚úÖ Producto actualizado correctamente.");
      }
    };

    btnEliminar.onclick = () => {
      if (confirm("üóëÔ∏è ¬øEliminar todos los productos? Esta acci√≥n no se puede deshacer.")) {
        localStorage.removeItem("agrolink_productos");
        renderizarTabla();
      }
    };

    /* === Auto-actualizaci√≥n al cambiar LocalStorage === */
    window.addEventListener("storage", e => {
      if (e.key === "agrolink_productos" || e.key === "productosAgroLink") {
        syncProductosConAdmin();
        renderizarTabla();
      }
    });

    /* === Inicializar === */
    window.onload = () => {
      syncProductosConAdmin();
      renderizarTabla();
    };
  </script>
</body>
</html>
